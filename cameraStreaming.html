<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>BazyGo â€“ Video Playback</title>

  <style>
    body { font-family: Arial; background:#f7f7f7; padding:20px; }
    .file { padding:10px; margin-bottom:5px; background:white; border-radius:5px; border:1px solid #ddd; cursor:pointer; }
    .file:hover { background:#eee; }
    .device-title { margin-top:25px; font-weight:bold; font-size:18px; }
    .cam-btn { padding:6px 12px; border:1px solid #888; margin-right:6px; border-radius:4px; cursor:pointer; display:inline-block; }
    .cam-btn.active { background:#007bff; color:white; border-color:#0056b3; }
  </style>
</head>

<body>

<h2>ðŸ“¹ Video Playback</h2>

<!-- Date Picker -->
<p>
  <label><b>Select Date:</b></label>
  <input type="date" id="datePicker" onchange="loadFiles()" />
</p>

<!-- Camera filter -->
<div>
  <span id="cam1" class="cam-btn active" onclick="setCamera(1)">Camera 1</span>
  <span id="cam2" class="cam-btn" onclick="setCamera(2)">Camera 2</span>
  <span id="camAll" class="cam-btn" onclick="setCamera('all')">All</span>
</div>

<p id="info"></p>

<div id="fileList"><i>Please select a date.</i></div>

<h3>Player</h3>
<video id="player" width="700" controls></video>

<script>
// ------------------ CONFIG ------------------
const SHEET_URL = "https://docs.google.com/spreadsheets/d/1GjVH6jlTGf7BEBqld0GEX1yMqUgfQc235g64CWdNyUM/gviz/tq?tqx=out:json";
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwwI70vwtzhZtzChTG7WzF-UvQIHm0z2iXNH70wYzB0vjgodvsT3ciHcaN0MohSmeMW/exec";

let cameraFilter = 1;

// ----------------- CAMERA BUTTON LOGIC ------------------
function setCamera(cam) {
  cameraFilter = cam;
  camUpdateUI();
  loadFiles();
}

function camUpdateUI() {
  document.getElementById("cam1").classList.toggle("active", cameraFilter === 1);
  document.getElementById("cam2").classList.toggle("active", cameraFilter === 2);
  document.getElementById("camAll").classList.toggle("active", cameraFilter === "all");
}

// ----------------- URL PARAMETERS ------------------
const urlParams = new URLSearchParams(window.location.search);
const rawParams = urlParams.get("params");

const decodedJSON = JSON.parse(decodeURIComponent(rawParams));
const deviceIdList = decodedJSON["ds16.devices"].split(",").map(x => x.trim());

// ----------------- HELPERS ------------------
function sheetDateToYMD(cell) {
  if (!cell || cell.v === null) return "";
  const jsDate = new Date((cell.v - 25569) * 86400000);
  jsDate.setHours(jsDate.getHours() + 3);
  return jsDate.toISOString().split("T")[0];
}

function cellVal(c){ return c ? (c.f || c.v) : ""; }

// ----------------- LOAD FILES ------------------
async function loadFiles() {

  const selectedDate = document.getElementById("datePicker").value;
  if (!selectedDate) {
    document.getElementById("fileList").innerHTML = "<p>Please select a date.</p>";
    return;
  }

  const res = await fetch(SHEET_URL);
  const text = await res.text();
  const json = JSON.parse(text.substring(47).slice(0,-2));

  const rows = json.table.rows.map(r => r.c);

  const listDiv = document.getElementById("fileList");
  listDiv.innerHTML = "";

  // Filter rows
  const filtered = rows.filter(row => {
    const rowDate     = sheetDateToYMD(row[0]);
    const rowDeviceId = String(row[6].v);
    const rowCamera   = String(row[4].v);

    const matchDate   = rowDate === selectedDate;
    const matchDevice = deviceIdList.includes(rowDeviceId);
    const matchCamera = 
      (cameraFilter === "all") || (rowCamera === String(cameraFilter));

    return matchDate && matchDevice && matchCamera;
  });

  if (!filtered.length) {
    listDiv.innerHTML = "<p>No videos found.</p>";
    return;
  }

  // Build device name map
  const deviceNames = {};
  rows.forEach(row => {
    const devId = String(row[6].v);
    const devName = row[7] ? row[7].v : "";
    deviceNames[devId] = devName;
  });

  document.getElementById("info").innerHTML =
    `Date: <b>${selectedDate}</b><br>
     Devices: ${deviceIdList.map(id => deviceNames[id] || id).join(", ")}`;

  // Group by device
  const grouped = {};
  filtered.forEach(r => {
    const dev = String(r[6].v);
    if (!grouped[dev]) grouped[dev] = [];
    grouped[dev].push(r);
  });

  // Render
  for (const devId of Object.keys(grouped)) {

    const title = document.createElement("div");
    title
