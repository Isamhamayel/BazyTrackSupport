<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>BazyGo â€“ Video Player</title>

<!-- Make it fit mobile screen -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- HLS.js for Android/PC -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
  * { box-sizing: border-box; }

  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: Arial, sans-serif;
    background: #f2f2f2;
  }

  /* Main page wrapper: top fixed area + scrollable file list */
  .page {
    display: flex;
    flex-direction: column;
    height: 100vh; /* full screen */
    width: 100vw;
  }

  /* Top panel: options + cam buttons + video */
  .top-panel {
    background: #ffffff;
    padding: 12px;
    border-bottom: 2px solid #ddd;
    flex: 0 0 auto; /* fixed height, no scroll */
  }

  .top-panel h3 {
    margin-top: 0;
    margin-bottom: 10px;
  }

  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    margin-bottom: 8px;
  }

  .controls label {
    font-size: 13px;
    margin-right: 4px;
  }

  .controls select,
  .controls input[type="date"] {
    padding: 5px;
    font-size: 13px;
  }

  .cam-buttons {
    margin: 6px 0 10px 0;
  }

  .cam-btn {
    padding: 4px 10px;
    border: 1px solid #999;
    margin-right: 6px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    display: inline-block;
    margin-bottom: 4px;
  }
  .cam-btn.active {
    background: #2196F3;
    color: white;
  }

  /* Video player */
  #player {
    width: 100%;
    height: auto;
    background: black;
    max-height: 60vh;
    border-radius: 8px;
  }

  /* Scrollable file list area */
  .file-panel {
    flex: 1 1 auto;          /* take remaining height */
    overflow-y: auto;        /* scroll only here */
    padding: 10px 12px;
    background: #fafafa;
  }

  .file {
    background: #f9f9f9;
    padding: 10px;
    margin: 6px 0;
    border-radius: 6px;
    border: 1px solid #ddd;
    cursor: pointer;
  }
  .file:hover {
    background: #ececec;
  }

  .time-label {
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
  }

  /* A bit nicer on larger screens */
  @media (min-width: 900px) {
    .top-panel {
      max-width: 900px;
      margin: 0 auto;
    }
    .file-panel {
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }
  }

</style>
</head>

<body>

<div class="page">

  <!-- TOP: options + cam buttons + video -->
  <div class="top-panel">
    <h3>ğŸ¥ BazyGo â€“ Ø§Ù„Ù…Ø´ØºÙ‘Ù„</h3>

    <div class="controls">
      <label>Ø§Ù„Ø¬Ù‡Ø§Ø²:</label>
      <select id="deviceSelect" onchange="loadFiles()"></select>

      <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
      <input type="date" id="datePicker" onchange="loadFiles()">

      <label>Ø§Ù„Ø³Ø§Ø¹Ø©:</label>
      <select id="hourPicker" onchange="loadFiles()"></select>
    </div>

    <div class="cam-buttons">
      <span id="c1" class="cam-btn active" onclick="setCam(1)">ÙƒØ§Ù…ÙŠØ±Ø§ 1</span>
      <span id="c2" class="cam-btn" onclick="setCam(2)">ÙƒØ§Ù…ÙŠØ±Ø§ 2</span>
      <span id="cAll" class="cam-btn" onclick="setCam('all')">Ø§Ù„ÙƒÙ„</span>
    </div>

    <video id="player"
           controls
           muted
           playsinline>
    </video>
  </div>

  <!-- BOTTOM: scrollable file list -->
  <div class="file-panel">
    <h4>ğŸ“ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h4>
    <div id="fileList"><i>Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ ÙˆØ§Ù„Ø³Ø§Ø¹Ø©...</i></div>
  </div>

</div>

<script>
/* ------------------------------------------------------------
   CONFIG
------------------------------------------------------------ */
const SHEET_ID = "1GjVH6jlTGf7BEBqld0GEX1yMqUgfQc235g64CWdNyUM";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwwI70vwtzhZtzChTG7WzF-UvQIHm0z2iXNH70wYzB0vjgodvsT3ciHcaN0MohSmeMW/exec";

/* ============================================================
   STATE
============================================================ */
let cameraFilter = 1;

/* ============================================================
   HOURS LIST
============================================================ */
const hourPicker = document.getElementById("hourPicker");
for (let h = 0; h < 24; h++) {
  const hh = h.toString().padStart(2, "0");
  const opt = document.createElement("option");
  opt.value = hh;
  opt.textContent = hh + ":00";
  hourPicker.appendChild(opt);
}

/* ============================================================
   CAMERA SELECT
============================================================ */
function setCam(c) {
  cameraFilter = c;

  document.getElementById("c1").classList.toggle("active", c === 1);
  document.getElementById("c2").classList.toggle("active", c === 2);
  document.getElementById("cAll").classList.toggle("active", c === "all");

  loadFiles();
}

/* ============================================================
   READ DEVICES FROM URL PARAMS
============================================================ */
const params = new URLSearchParams(window.location.search);
const devicesJSON = params.get("params");
const decoded = devicesJSON ? JSON.parse(decodeURIComponent(devicesJSON)) : {};
const deviceList = decoded["ds16.devices"] ? decoded["ds16.devices"].split(",") : [];

const deviceSelect = document.getElementById("deviceSelect");
deviceList.forEach(id => {
  id = id.trim();
  if (!id) return;
  const opt = document.createElement("option");
  opt.value = id;
  opt.textContent = "Device " + id;
  deviceSelect.appendChild(opt);
});

/* ============================================================
   LOAD FILES
============================================================ */
async function loadFiles() {

  const deviceId = deviceSelect.value;
  const dateSel  = document.getElementById("datePicker").value;
  const hourSel  = document.getElementById("hourPicker").value;

  const fileList = document.getElementById("fileList");

  if (!deviceId || !dateSel || !hourSel) {
    fileList.innerHTML = "Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ ÙˆØ§Ù„Ø³Ø§Ø¹Ø©.";
    return;
  }

  const sql = `select * where G=${deviceId} order by A desc`;
  const url = SHEET_URL + "&tq=" + encodeURIComponent(sql);

  fileList.innerHTML = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

  try {
    const res = await fetch(url);
    const txt = await res.text();
    const json = JSON.parse(txt.substring(47).slice(0, -2));

    const rows = json.table.rows || [];
    const out = [];

    rows.forEach(r => {
      const cols = r.c;
      if (!cols) return;

      const raw = cols[0].f; // "MM/DD/YYYY HH:MM:SS"
      const [mdy, time] = raw.split(" ");
      const [M, D, Y] = mdy.split("/");

      const yyyy_mm_dd = `${Y}-${M.padStart(2,"0")}-${D.padStart(2,"0")}`;
      const hh = time.split(":")[0].padStart(2,"0");

      if (yyyy_mm_dd !== dateSel) return;
      if (hh !== hourSel) return;

      const camVal = cols[4]?.v;
      if (cameraFilter !== "all" && String(camVal) !== String(cameraFilter)) return;

      out.push({
        time,
        filename: cols[2].v,
        imei: cols[1].f,
        deviceId: cols[6].v
      });
    });

    if (!out.length) {
      fileList.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ø§Ø¹Ø©.";
      return;
    }

    fileList.innerHTML = "";
    out.forEach(v => {
      const div = document.createElement("div");
      div.className = "file";
      div.innerHTML = `<div class="time-label">${v.filename}</div>${v.time}`;
      div.onclick = () => playVideo(v.filename, v.deviceId, v.imei);
      fileList.appendChild(div);
    });

  } catch (e) {
    fileList.innerHTML = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
    console.error(e);
  }
}

/* ============================================================
   STREAM PLAYER (iOS + ANDROID + PC)
============================================================ */

// Stop old stream
function stopPlayer() {
  const video = document.getElementById("player");

  if (window.hls) {
    try { window.hls.destroy(); } catch (e) {}
    window.hls = null;
  }

  video.pause();
  video.removeAttribute("src");
  video.load();
}

// When user clicks a file
function playVideo(fname, deviceId, imei) {

  stopPlayer(); // clear previous playback

  // tell camera to start playback
  fetch(`${WEBAPP_URL}?type=playback&deviceId=${deviceId}&fileName=${fname}`);

  const stream = `https://streaming.bazytrack.jo/live/0/${imei}/index.m3u8`;
  const video = document.getElementById("player");

  checkStream(stream, video);
}

// Retry every 1 second until the HLS stream is ready
function checkStream(url, video) {
  fetch(url, { method: "HEAD" })
    .then(res => {
      if (res.ok) {
        startPlayback(url, video);
      } else {
        setTimeout(() => checkStream(url, video), 1000);
      }
    })
    .catch(() => {
      setTimeout(() => checkStream(url, video), 1000);
    });
}

// Start playback depending on platform
function startPlayback(url, video) {

  // iOS / Safari: native HLS support
  if (video.canPlayType("application/vnd.apple.mpegurl")) {
    video.src = url;
    video.play().catch(err => console.log("iOS autoplay error:", err));
    return;
  }

  // Other browsers: Hls.js
  if (Hls.isSupported()) {
    if (window.hls) window.hls.destroy();

    window.hls = new Hls({
      maxBufferLength: 5,
      maxMaxBufferLength: 10
    });

    window.hls.loadSource(url);
    window.hls.attachMedia(video);

    window.hls.on(Hls.Events.MANIFEST_PARSED, () => {
      video.play().catch(err => console.log("HLS play error:", err));
    });

    window.hls.on(Hls.Events.ERROR, (event, data) => {
      console.log("HLS error:", data);
    });
  }
}

</script>

</body>
</html>
