<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>BazyGo â€“ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- FLV.js for Chrome/Android/PC -->
<script src="https://cdn.jsdelivr.net/npm/flv.js/dist/flv.min.js"></script>

<style>
* { box-sizing: border-box; }
body { margin:0; font-family:Arial; background:#f2f2f2; }

.page {
    display:flex;
    flex-direction:column;
    height:100vh;
}

.top-panel {
    background:white;
    padding:12px;
    border-bottom:2px solid #ddd;
    position:relative;
}

.file-panel {
    flex:1;
    overflow-y:auto;
    padding:12px;
    background:#fafafa;
}

#player {
    width:100%;
    background:black;
    border-radius:8px;
    max-height:60vh;
}

.controls {
    margin-top:10px;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
}

.controls select,
.controls input[type="date"] {
    padding:6px;
    font-size:13px;
}

.cam-btn {
    padding:5px 12px;
    border:1px solid #888;
    border-radius:4px;
    margin-left:6px;
    cursor:pointer;
    font-size:13px;
}
.cam-btn.active { background:#2196F3; color:white; }

.file {
    background:white;
    padding:10px;
    margin:6px 0;
    border-radius:6px;
    border:1px solid #ddd;
    cursor:pointer;
}
.file:hover { background:#eee; }

#loadingOverlay {
    position:absolute;
    top:0; left:0; right:0;
    background:rgba(255,255,255,0.85);
    padding:15px;
    text-align:center;
    font-size:15px;
    display:none;
}

.spinner {
    width:30px;
    height:30px;
    border:4px solid #ccc;
    border-top:4px solid #2196F3;
    border-radius:50%;
    margin:10px auto;
    animation:spin 0.8s linear infinite;
}

@keyframes spin { 100% { transform:rotate(360deg); } }

@media(min-width:768px){
    .page { flex-direction:row; }
    .top-panel {
        flex:0 0 55%;
        height:100vh;
        border-left:2px solid #ddd;
        padding:20px;
    }
    .file-panel {
        flex:0 0 45%;
        height:100vh;
        background:white;
        padding:20px;
        border-right:2px solid #ddd;
    }
    #player {
        height:480px;
    }
}
</style>
</head>

<body>

<div class="page">

    <!-- PLAYER + FILTERS -->
    <div class="top-panel">
        <h3>ğŸ¥ Ù…Ø´ØºÙ‘Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</h3>

        <div id="loadingOverlay">
            <div class="spinner"></div>
            Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...
        </div>

        <video id="player" controls muted playsinline></video>

        <div class="controls">
            <label>Ø§Ù„Ø¬Ù‡Ø§Ø²:</label>
            <select id="deviceSelect" onchange="loadFiles()"></select>

            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
            <input type="date" id="datePicker" onchange="loadFiles()">

            <label>Ø§Ù„Ø³Ø§Ø¹Ø©:</label>
            <select id="hourPicker" onchange="loadFiles()"></select>
        </div>

        <div style="margin-top:10px;">
            <span id="c1" class="cam-btn active" onclick="setCam(1)">ÙƒØ§Ù…ÙŠØ±Ø§ 1</span>
            <span id="c2" class="cam-btn" onclick="setCam(2)">ÙƒØ§Ù…ÙŠØ±Ø§ 2</span>
            <span id="cAll" class="cam-btn" onclick="setCam('all')">Ø§Ù„ÙƒÙ„</span>
        </div>
    </div>

    <!-- FILE LIST -->
    <div class="file-panel">
        <h4>ğŸ“ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h4>
        <div id="fileList"><i>Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø³Ø§Ø¹Ø©...</i></div>
    </div>

</div>

<script>
/* ------------------------------------------------------------
   CONFIG
------------------------------------------------------------ */
const SHEET_ID = "1GjVH6jlTGf7BEBqld0GEX1yMqUgfQc235g64CWdNyUM";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwwI70vwtzhZtzChTG7WzF-UvQIHm0z2iXNH70wYzB0vjgodvsT3ciHcaN0MohSmeMW/exec";

const SRS_RTC_API = "https://streaming.bazytrack.jo/rtc/v1/play/";
const SRS_HOST = "streaming.bazytrack.jo";

let cameraFilter = 1;
const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

/* ------------------------------------------------------------
   UI helpers
------------------------------------------------------------ */
function showLoading(state){ 
    document.getElementById("loadingOverlay").style.display = state ? "block":"none"; 
}

function stopPlayer() {
    const v = document.getElementById("player");

    if (window.webrtcPC) {
        try { window.webrtcPC.close(); } catch(e){}
        window.webrtcPC = null;
    }
    if (window.flvPlayer) {
        try { window.flvPlayer.destroy(); } catch(e){}
        window.flvPlayer = null;
    }

    v.pause();
    v.srcObject = null;
    v.removeAttribute("src");
    v.load();
}

/* ------------------------------------------------------------
   Playback: WebRTC (Safari)
------------------------------------------------------------ */
async function playWebRTC(imei) {
    stopPlayer();
    showLoading(true);

    const video = document.getElementById("player");
    const streamUrl = `webrtc://${SRS_HOST}/live/0/${imei}`;

    const pc = new RTCPeerConnection({
        iceServers: [{ urls: ["stun:stun.l.google.com:19302"] }]
    });
    window.webrtcPC = pc;

    pc.ontrack = e => {
        video.srcObject = e.streams[0];
        video.play();
        showLoading(false);
    };

    const offer = await pc.createOffer({ offerToReceiveVideo: true });
    await pc.setLocalDescription(offer);

    const req = {
        api: SRS_RTC_API,
        streamurl: streamUrl,
        sdp: offer.sdp
    };

    const res = await fetch(SRS_RTC_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(req)
    });

    const data = await res.json();

    if (data.code !== 0) {
        console.error("WebRTC error:", data);
        showLoading(false);
        return;
    }

    await pc.setRemoteDescription(
        new RTCSessionDescription({ type:"answer", sdp:data.sdp })
    );
}

/* ------------------------------------------------------------
   Playback: FLV (Chrome/Android/PC)
------------------------------------------------------------ */
function playFLV(imei) {
    stopPlayer();
    showLoading(true);

    const video = document.getElementById("player");
    const flvUrl = `wss://${SRS_HOST}/live/0/${imei}.flv`;

    if (flvjs.isSupported()) {
        window.flvPlayer = flvjs.createPlayer({
            type:"flv",
            url:flvUrl
        });

        window.flvPlayer.attachMediaElement(video);
        window.flvPlayer.load();
        window.flvPlayer.play().then(()=>{
            showLoading(false);
        });
    } else {
        alert("FLV ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.");
        showLoading(false);
    }
}

/* ------------------------------------------------------------
   Playback Auto-Select
------------------------------------------------------------ */
function playVideo(fname, deviceId, imei) {
    stopPlayer();
    showLoading(true);

    // Start camera playback on server
    fetch(`${WEBAPP_URL}?type=playback&deviceId=${deviceId}&fileName=${fname}`);

    // Safari â†’ WebRTC
    if (isSafari) {
        playWebRTC(imei);
    }
    // Others â†’ FLV
    else {
        playFLV(imei);
    }
}

/* ------------------------------------------------------------
   Camera Filters
------------------------------------------------------------ */
function setCam(c){
    cameraFilter = c;
    c1.classList.toggle("active", c===1);
    c2.classList.toggle("active", c===2);
    cAll.classList.toggle("active", c==="all");
    loadFiles();
}

/* ------------------------------------------------------------
   Load Devices from URL params
------------------------------------------------------------ */
const params = new URLSearchParams(window.location.search);
const decoded = params.get("params") ? JSON.parse(decodeURIComponent(params.get("params"))) : {};
(decoded["ds16.devices"] || "").split(",").map(x=>x.trim()).filter(Boolean)
.forEach(id => {
    deviceSelect.innerHTML += `<option value="${id}">Device ${id}</option>`;
});

/* ------------------------------------------------------------
   Populate Hours
------------------------------------------------------------ */
for (let h=0; h<24; h++){
    const hh = h.toString().padStart(2,"0");
    hourPicker.innerHTML += `<option value="${hh}">${hh}:00</option>`;
}

/* ------------------------------------------------------------
   Load videos from Google Sheet
------------------------------------------------------------ */
async function loadFiles() {
    const id = deviceSelect.value;
    const date = datePicker.value;
    const hour = hourPicker.value;
    const fileList = document.getElementById("fileList");

    if (!id || !date || !hour) {
        fileList.innerHTML = "Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø³Ø§Ø¹Ø©.";
        return;
    }

    fileList.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

    const sql = `select * where G=${id} order by A desc`;
    const url = SHEET_URL + "&tq=" + encodeURIComponent(sql);

    try {
        const txt = await (await fetch(url)).text();
        const json = JSON.parse(txt.substring(47).slice(0,-2));

        const rows = json.table.rows || [];
        const out = [];

        rows.forEach(r=>{
            const c = r.c;
            if(!c) return;

            const raw = c[0].f; // "11/26/2025 9:03:52"
            const [mdy, t] = raw.split(" ");
            const [M,D,Y] = mdy.split("/");

            const d2 = `${Y}-${M.padStart(2,"0")}-${D.padStart(2,"0")}`;
            const hh = t.split(":")[0].padStart(2,"0");

            if (d2!==date) return;
            if (hh!==hour) return;

            if (cameraFilter!=="all" && String(c[4]?.v)!==String(cameraFilter)) return;

            out.push({
                time:t,
                filename:c[2].v,
                imei:c[1].f,
                deviceId:c[6].v
            });
        });

        if (!out.length) {
            fileList.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª.";
            return;
        }

        fileList.innerHTML = "";
        out.forEach(v=>{
            fileList.innerHTML += `
                <div class="file" onclick="playVideo('${v.filename}','${v.deviceId}','${v.imei}')">
                    <div>${v.filename}</div>
                    <small>${v.time}</small>
                </div>
            `;
        });

    } catch(e){
        fileList.innerHTML = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
    }
}
</script>

</body>
</html>
