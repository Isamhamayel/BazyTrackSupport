<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>BazyGo â€“ Video Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- HLS.js for Android/PC -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
  * { box-sizing: border-box; }
  body { margin:0; font-family:Arial; background:#f2f2f2; }

  /* MOBILE LAYOUT (default) */
  .page {
    display:flex;
    flex-direction:column;
    height:100vh;
    width:100vw;
  }

  .top-panel {
    background:white;
    padding:12px;
    border-bottom:2px solid #ddd;
    flex:0 0 auto;
  }

  .file-panel {
    flex:1 1 auto;
    overflow-y:auto;
    padding:12px;
    background:#fafafa;
  }

  #player {
    width:100%;
    height:auto;
    background:black;
    max-height:60vh;
    border-radius:8px;
  }

  .controls {
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
    margin-bottom:8px;
  }

  .controls label {
    font-size:13px;
  }

  .controls select,
  .controls input[type="date"] {
    padding:5px;
    font-size:13px;
  }

  .cam-buttons {
    margin-bottom:10px;
  }

  .cam-btn {
    padding:4px 10px;
    border:1px solid #999;
    margin-left:6px;
    border-radius:4px;
    cursor:pointer;
    font-size:13px;
    display:inline-block;
  }
  .cam-btn.active {
    background:#2196F3;
    color:white;
  }

  .file {
    background:#fff;
    padding:10px;
    margin:6px 0;
    border-radius:6px;
    border:1px solid #ddd;
    cursor:pointer;
  }
  .file:hover { background:#ececec; }

  .time-label {
    font-size:12px;
    color:#666;
    margin-bottom:4px;
  }

  /* DESKTOP LAYOUT */
  @media (min-width: 768px) {

    .page {
      flex-direction:row;
    }

    .top-panel {
      flex:0 0 55%;
      height:100vh;
      overflow-y:auto;
      border-left:2px solid #ddd;
      border-bottom:none;
      padding:20px;
    }

    .file-panel {
      flex:0 0 45%;
      height:100vh;
      overflow-y:auto;
      padding:20px;
      background:white;
      border-right:2px solid #ddd;
    }

    #player {
      height:480px;
      max-height:480px;
    }
  }
</style>

</head>

<body>

<div class="page">

  <!-- LEFT ON DESKTOP / TOP ON MOBILE -->
  <div class="top-panel">
    <h3>ğŸ¥ Ø§Ù„Ù…Ø´ØºÙ‘Ù„</h3>

    <div class="controls">
      <label>Ø§Ù„Ø¬Ù‡Ø§Ø²:</label>
      <select id="deviceSelect" onchange="loadFiles()"></select>

      <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
      <input type="date" id="datePicker" onchange="loadFiles()">

      <label>Ø§Ù„Ø³Ø§Ø¹Ø©:</label>
      <select id="hourPicker" onchange="loadFiles()"></select>
    </div>

    <div class="cam-buttons">
      <span id="c1" class="cam-btn active" onclick="setCam(1)">ÙƒØ§Ù…ÙŠØ±Ø§ 1</span>
      <span id="c2" class="cam-btn" onclick="setCam(2)">ÙƒØ§Ù…ÙŠØ±Ø§ 2</span>
      <span id="cAll" class="cam-btn" onclick="setCam('all')">Ø§Ù„ÙƒÙ„</span>
    </div>

    <video id="player" controls muted playsinline></video>
  </div>

  <!-- RIGHT ON DESKTOP / BOTTOM ON MOBILE -->
  <div class="file-panel">
    <h4>ğŸ“ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h4>
    <div id="fileList"><i>Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ ÙˆØ§Ù„Ø³Ø§Ø¹Ø©...</i></div>
  </div>

</div>

<script>
/* ------------------------------------------------------------
   CONFIG
------------------------------------------------------------ */
const SHEET_ID = "1GjVH6jlTGf7BEBqld0GEX1yMqUgfQc235g64CWdNyUM";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwwI70vwtzhZtzChTG7WzF-UvQIHm0z2iXNH70wYzB0vjgodvsT3ciHcaN0MohSmeMW/exec";

/* ============================================================
   STATE
============================================================ */
let cameraFilter = 1;

/* Populate hours */
const hourPicker = document.getElementById("hourPicker");
for (let h = 0; h < 24; h++) {
  const hh = h.toString().padStart(2, "0");
  const opt = document.createElement("option");
  opt.value = hh;
  opt.textContent = hh + ":00";
  hourPicker.appendChild(opt);
}

/* Camera filter */
function setCam(c) {
  cameraFilter = c;
  document.getElementById("c1").classList.toggle("active", c === 1);
  document.getElementById("c2").classList.toggle("active", c === 2);
  document.getElementById("cAll").classList.toggle("active", c === "all");
  loadFiles();
}

/* Read devices from URL params */
const params = new URLSearchParams(window.location.search);
const devicesJSON = params.get("params");
const decoded = devicesJSON ? JSON.parse(decodeURIComponent(devicesJSON)) : {};
const deviceList = decoded["ds16.devices"] ? decoded["ds16.devices"].split(",") : [];

const deviceSelect = document.getElementById("deviceSelect");
deviceList.forEach(id => {
  id = id.trim();
  if (!id) return;
  const opt = document.createElement("option");
  opt.value = id;
  opt.textContent = "Device " + id;
  deviceSelect.appendChild(opt);
});

/* Load files list */
async function loadFiles() {
  const deviceId = deviceSelect.value;
  const dateSel  = document.getElementById("datePicker").value;
  const hourSel  = document.getElementById("hourPicker").value;
  const fileList = document.getElementById("fileList");

  if (!deviceId || !dateSel || !hourSel) {
    fileList.innerHTML = "Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ ÙˆØ§Ù„Ø³Ø§Ø¹Ø©.";
    return;
  }

  const sql = `select * where G=${deviceId} order by A desc`;
  const url = SHEET_URL + "&tq=" + encodeURIComponent(sql);

  fileList.innerHTML = "Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

  try {
    const res = await fetch(url);
    const txt = await res.text();
    const json = JSON.parse(txt.substring(47).slice(0, -2));

    const rows = json.table.rows || [];
    const out = [];

    rows.forEach(r => {
      const c = r.c;
      if (!c) return;

      const raw = c[0].f;
      const [mdy, t] = raw.split(" ");
      const [M, D, Y] = mdy.split("/");

      const date = `${Y}-${M.padStart(2,"0")}-${D.padStart(2,"0")}`;
      const hh = t.split(":")[0].padStart(2,"0");

      if (date !== dateSel) return;
      if (hh !== hourSel) return;

      const cam = c[4]?.v;
      if (cameraFilter !== "all" && String(cam) !== String(cameraFilter)) return;

      out.push({
        time: t,
        filename: c[2].v,
        imei: c[1].f,
        deviceId: c[6].v
      });
    });

    if (!out.length) {
      fileList.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ø§Ø¹Ø©.";
      return;
    }

    fileList.innerHTML = "";
    out.forEach(v => {
      const item = document.createElement("div");
      item.className = "file";
      item.innerHTML = `<div class="time-label">${v.filename}</div>${v.time}`;
      item.onclick = () => playVideo(v.filename, v.deviceId, v.imei);
      fileList.appendChild(item);
    });

  } catch (e) {
    fileList.innerHTML = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
    console.error(e);
  }
}

/* ============================================================
   STREAM PLAYER (HLS)
============================================================ */
function stopPlayer() {
  const video = document.getElementById("player");
  if (window.hls) {
    try { window.hls.destroy(); } catch (e) {}
    window.hls = null;
  }
  video.pause();
  video.removeAttribute("src");
  video.load();
}

function playVideo(fname, deviceId, imei) {

  stopPlayer();

  // Tell camera to start streaming
  fetch(`${WEBAPP_URL}?type=playback&deviceId=${deviceId}&fileName=${fname}`);

  const base = `https://streaming.bazytrack.jo/live/0/`;
  const m3u8 = `${base}${imei}.m3u8`;

  checkHLSReady(base, imei, m3u8, 0);
}

// Check m3u8 + first .ts segment
async function checkHLSReady(base, imei, m3u8, attempt) {

  if (attempt > 60) {
    console.log("Stream timeout.");
    return;
  }

  try {
    const res = await fetch(m3u8);
    if (!res.ok) {
      return setTimeout(() => checkHLSReady(base, imei, m3u8, attempt + 1), 1000);
    }

    const text = await res.text();

    const match = text.match(/(seg-\d+\.ts)/);
    if (!match) {
      return setTimeout(() => checkHLSReady(base, imei, m3u8, attempt + 1), 1000);
    }

    const tsFile = match[1];
    const tsUrl = `${base}${tsFile}`;

    const seg = await fetch(tsUrl, { method:"HEAD" });
    if (seg.ok) {
      console.log("HLS ready!");
      return startPlayback(m3u8);
    }

  } catch (err) {}

  setTimeout(() => checkHLSReady(base, imei, m3u8, attempt + 1), 1000);
}

function startPlayback(m3u8) {
  const video = document.getElementById("player");

  // iPhone Safari native HLS
  if (video.canPlayType("application/vnd.apple.mpegurl")) {
    video.src = m3u8;
    video.play().catch(err => console.log("iOS play error:", err));
    return;
  }

  // Android & PC Hls.js
  if (Hls.isSupported()) {

    if (window.hls) window.hls.destroy();

    window.hls = new Hls({
      maxBufferLength:5,
      maxMaxBufferLength:10
    });

    window.hls.loadSource(m3u8);
    window.hls.attachMedia(video);

    window.hls.on(Hls.Events.MANIFEST_PARSED, () => {
      video.play().catch(err => console.log("playback err:", err));
    });
  }
}

</script>

</body>
</html>
