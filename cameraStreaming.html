<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>BazyGo â€“ Ù…Ø´ØºÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- FLV.js Ù„Ù„Ù€ Chrome / Android -->
<script src="https://cdn.jsdelivr.net/npm/flv.js/dist/flv.min.js"></script>

<style>
* { box-sizing:border-box; }
body { margin:0; font-family:'Tahoma',Arial; background:#f7f7f7; }

header {
    padding:10px 15px;
    background:white;
    font-size:18px;
    font-weight:bold;
    border-bottom:1px solid #ddd;
}

/* LAYOUT */
.container {
    display:flex;
    height:calc(100vh - 50px);
}

/* LEFT: FILTERS + FILES */
.left {
    width:40%;
    background:white;
    border-left:1px solid #ddd;
    padding:10px;
    display:flex;
    flex-direction:column;
    overflow:hidden;
}

.filters {
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-bottom:8px;
}

.filters select,
.filters input[type=date] {
    padding:6px;
    border-radius:6px;
    border:1px solid #ccc;
    font-size:13px;
}

.cam-buttons {
    margin-bottom:8px;
}

.cam-btn {
    padding:5px 10px;
    border-radius:6px;
    border:1px solid #aaa;
    cursor:pointer;
    margin-left:6px;
    background:#fafafa;
    font-size:12px;
}
.cam-btn.active {
    background:#2196F3;
    color:white;
    border-color:#2196F3;
}

/* FILE LIST SCROLL ONLY */
.file-list {
    flex:1;
    overflow-y:auto;
    margin-top:5px;
}

.file-item {
    background:#fafafa;
    padding:10px;
    margin-bottom:8px;
    border-radius:6px;
    border:1px solid #ddd;
    cursor:pointer;
    transition:0.15s;
    font-size:13px;
}
.file-item:hover {
    background:#e7f2ff;
    border-color:#2196F3;
}

.time-label {
    font-size:11px;
    color:#666;
    margin-bottom:4px;
}

/* RIGHT: VIDEO Ø«Ø§Ø¨Øª Ø¨Ø¯ÙˆÙ† Scroll */
.right {
    width:60%;
    padding:10px;
    background:#fdfdfd;
    display:flex;
    flex-direction:column;
    position:relative;
}

#errorMessage {
    display:none;
    padding:8px;
    background:#ffeded;
    color:#a00;
    border:1px solid #dd9999;
    border-radius:6px;
    margin-bottom:8px;
    font-size:13px;
    text-align:center;
}

#downloadBtn {
    display:none;
    margin-bottom:8px;
    padding:8px 12px;
    background:#28a745;
    color:white;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-size:13px;
}

#downloadBtn:hover {
    background:#218838;
}

#videoWrapper {
    position:relative;
    flex:1;
    display:flex;
    align-items:center;
    justify-content:center;
}

#videoPlayer {
    width:100%;
    height:100%;
    max-height:100%;
    background:black;
    border-radius:8px;
}

/* LOADING OVERLAY */
#loadingOverlay {
    position:absolute;
    top:0; left:0; right:0; bottom:0;
    background:rgba(255,255,255,0.9);
    display:none;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    border-radius:8px;
}

.spinner {
    width:30px; height:30px;
    border:4px solid #ccc;
    border-top:4px solid #2196F3;
    border-radius:50%;
    animation:spin .7s linear infinite;
}
@keyframes spin { 100% { transform:rotate(360deg); } }

/* MOBILE */
@media(max-width:900px){
    .container {
        flex-direction:column;
        height:auto;
    }
    .left {
        width:100%;
        height:45vh;
    }
    .right {
        width:100%;
        height:55vh;
    }
    #videoWrapper {
        height:100%;
    }
}
</style>
</head>

<body>

<header>ğŸ¥ Ù…Ø´ØºÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª â€“ BazyGo</header>

<div class="container">

    <!-- LEFT SIDE: FILTERS + FILES -->
    <div class="left">
        <div class="filters">
            <select id="deviceSelect" onchange="loadFiles()"></select>
            <input type="date" id="datePicker" onchange="loadFiles()">
            <select id="hourPicker" onchange="loadFiles()"></select>
        </div>

        <div class="cam-buttons">
            <span id="btnC1" class="cam-btn active" onclick="setCam(1)">ÙƒØ§Ù…ÙŠØ±Ø§ 1</span>
            <span id="btnC2" class="cam-btn" onclick="setCam(2)">ÙƒØ§Ù…ÙŠØ±Ø§ 2</span>
            <span id="btnCAll" class="cam-btn" onclick="setCam('all')">Ø§Ù„ÙƒÙ„</span>
        </div>

        <div id="fileList" class="file-list">
            <i>Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø³Ø§Ø¹Ø©...</i>
        </div>
    </div>

    <!-- RIGHT SIDE: VIDEO -->
    <div class="right">
        <div id="errorMessage"></div>

        <!-- Ø²Ø± ØªØ­Ù…ÙŠÙ„ ÙŠÙØªØ­ Ø®Ø§Ø±Ø¬ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
        <button id="downloadBtn" onclick="openExternalDownload()">
            â¬‡ ÙØªØ­ Ù…Ù„Ù FLV ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
        </button>

        <div id="videoWrapper">
            <video id="videoPlayer"
                   controls
                   playsinline
                   webkit-playsinline
                   onclick="manualPlayInIOS()">
            </video>

            <div id="loadingOverlay">
                <div class="spinner"></div>
                <div style="margin-top:8px;font-size:13px;">Ø¬Ø§Ø±Ù ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...</div>
            </div>
        </div>
    </div>

</div>

<script>
/* ===================== CONFIG ===================== */
const FILE_SHEET_ID   = "1GjVH6jlTGf7BEBqld0GEX1yMqUgfQc235g64CWdNyUM";
const DEVICE_SHEET_ID = FILE_SHEET_ID; // Ù†ÙØ³ Ø§Ù„Ù…Ù„ÙØŒ Ø´ÙŠØª Ø¨Ø§Ø³Ù… Devices

const FILE_SHEET_URL =
  `https://docs.google.com/spreadsheets/d/${FILE_SHEET_ID}/gviz/tq?tqx=out:json`;

const DEVICE_SHEET_URL =
  `https://docs.google.com/spreadsheets/d/${DEVICE_SHEET_ID}/gviz/tq?tqx=out:json&sheet=Devices`;

const WEBAPP_URL =
  "https://script.google.com/macros/s/AKfycbwwI70vwtzhZtzChTG7WzF-UvQIHm0z2iXNH70wYzB0vjgodvsT3ciHcaN0MohSmeMW/exec";

const STREAM_HOST = "streaming.bazytrack.jo";

/* ===================== STATE ===================== */
const ua = navigator.userAgent;
const isIOS    = /iPad|iPhone|iPod/.test(ua);
const isSafari = /^((?!chrome|android).)*safari/i.test(ua);

let cameraFilter = 1;
let flvPlayer = null;

let deviceNames = {}; // deviceId -> name
let deviceImeis = {}; // deviceId -> imei

let currentDownloadUrl = "";

/* ===================== HELPERS ===================== */
function showLoading(flag){
    document.getElementById("loadingOverlay").style.display = flag ? "flex" : "none";
}

function showError(msg){
    const box = document.getElementById("errorMessage");
    if (!msg){
        box.style.display = "none";
        box.textContent = "";
        return;
    }
    box.textContent = msg;
    box.style.display = "block";
}

function stopPlayback(){
    const v = document.getElementById("videoPlayer");
    if (flvPlayer){
        flvPlayer.destroy();
        flvPlayer = null;
    }
    v.pause();
    v.removeAttribute("src");
    v.srcObject = null;
    v.load();
}

/* iOS WebView: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§Ø²Ù… ÙŠØ¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„ØªØ´ØºÙŠÙ„Ù‡ */
function manualPlayInIOS(){
    if (!isIOS) return;
    const v = document.getElementById("videoPlayer");
    v.play().catch(()=>{});
}

/* ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø®Ø§Ø±Ø¬ ØªØ·Ø¨ÙŠÙ‚ Traccar (Ø¥Ù† Ø£Ù…ÙƒÙ†) */
function openExternalDownload() {
    if (!currentDownloadUrl) return;

    const url = currentDownloadUrl;

    const isAndroid = /Android/i.test(navigator.userAgent);
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

    if (isAndroid) {
        // Ù…Ø­Ø§ÙˆÙ„Ø© ÙØªØ­ Chrome Ù…Ø¨Ø§Ø´Ø±Ø©
        window.location.href = "googlechrome://navigate?url=" + url;

        // ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ÙŠÙ†Ø¬Ø­ Ù†Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø£Ø®Ø±Ù‰
        setTimeout(() => {
            window.location.href = url; 
        }, 800);

        return;
    }

    if (isIOS) {
        // iPhone â†’ Safari
        window.location.href = url;
        return;
    }

    // Ø§Ù„ÙˆÙŠØ¨ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    window.open(url, "_blank");
}


/* ===================== LOAD DEVICES SHEET ===================== */
async function loadDeviceNames() {
    const query = "select A,B,C"; // deviceId, imei, name
    const url = DEVICE_SHEET_URL + "&tq=" + encodeURIComponent(query);

    try {
        const res = await fetch(url);
        const txt = await res.text();
        const json = JSON.parse(txt.substring(47).slice(0,-2));
        const rows = json.table.rows || [];

        rows.forEach(r => {
            const deviceId = r.c[0]?.v;
            const imei     = r.c[1]?.v;
            const name     = r.c[2]?.v;

            if (!deviceId) return;

            deviceNames[deviceId] = name || ("Ø¬Ù‡Ø§Ø² " + deviceId);
            deviceImeis[deviceId] = imei;
        });

        console.log("Device names:", deviceNames);

    } catch(err) {
        console.error("Error loading device names:", err);
    }
}

/* ===================== RETRY PLAY (Ù„Ù„Ù€ FLV/HLS) ===================== */
function retryPlay(url, isFlv){
    const video = document.getElementById("videoPlayer");
    const btn   = document.getElementById("downloadBtn");

    let attempts = 0;
    let intervalCheck = null;
    let ready = false;

    showError("");
    btn.style.display = "none";

    function stopRetry(success){
        ready = true;
        clearInterval(intervalCheck);
        showLoading(false);

        if (success){
            btn.style.display = "inline-block";
        }
    }

    function tryLoad(){
        if (ready) return;
        attempts++;

        stopPlayback();

        if (isFlv){
            if (flvjs.isSupported()){
                flvPlayer = flvjs.createPlayer({
                    type: "flv",
                    url: url
                });

                flvPlayer.attachMediaElement(video);

                flvPlayer.on(flvjs.Events.STATISTICS_INFO, () => stopRetry(true));
                flvPlayer.on(flvjs.Events.LOADING_COMPLETE, () => stopRetry(true));

                flvPlayer.load();
                video.play().catch(()=>{});
            }

        } else {
            // HLS
            video.src = url;
            video.play().then(()=> stopRetry(true)).catch(()=>{});
        }

        intervalCheck = setInterval(() => {
            if (video.currentTime > 0 && !video.paused){
                stopRetry(true);
            }
        }, 300);

        setTimeout(() => {
            if (ready) return;

            if (attempts < 30){
                console.log("Retry:", attempts);
                tryLoad();
            } else {
                showLoading(false);
                showError("âš  ØªØ¹Ø°Ù‘Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„.");
                clearInterval(intervalCheck);
            }
        }, 1200);
    }

    tryLoad();
}

/* ===================== PLAY VIDEO ===================== */
function playVideo(filename, deviceId){
    stopPlayback();
    showLoading(true);
    showError("");

    const imei = deviceImeis[deviceId];
    if (!imei){
        showLoading(false);
        showError("Ù„Ø§ ÙŠÙˆØ¬Ø¯ IMEI Ù…Ø¹Ø±Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙŠ Ø¬Ø¯ÙˆÙ„ Devices.");
        return;
    }

    // Ø£Ù…Ø± ØªØ´ØºÙŠÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ø¨Ø± Google Script
    fetch(`${WEBAPP_URL}?type=playback&deviceId=${deviceId}&fileName=${filename}`);

    // Ø±Ø§Ø¨Ø· FLV Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ù„ØªØ­Ù…ÙŠÙ„
    const flvUrl = `https://${STREAM_HOST}/live/0/${imei}.flv`;
    currentDownloadUrl = flvUrl;
    document.getElementById("downloadBtn").style.display = "none";

    const video = document.getElementById("videoPlayer");

    // iOS WebView: HLS ÙÙ‚Ø· + Ø¨Ø¯ÙˆÙ† retry Ø£Ùˆ autoplay
    if (isIOS){
        const hlsUrl = `https://${STREAM_HOST}/live/0/${imei}.m3u8`;
        showLoading(false);
        video.src = hlsUrl;
        showError("ğŸ“± Ø¹Ù„Ù‰ Ø§Ù„Ø¢ÙŠÙÙˆÙ†: Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„ØªØ´ØºÙŠÙ„. Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¹Ù…Ù„ ÙÙˆØ±Ø§Ù‹ Ø§Ù†ØªØ¸Ø± Ø«ÙˆØ§Ù†Ù Ø«Ù… Ø§Ø¶ØºØ· Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        document.getElementById("downloadBtn").style.display = "inline-block";
        return;
    }

    // Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰:
    const hlsUrl = `https://${STREAM_HOST}/live/0/${imei}.m3u8`;

    if (isSafari){
        // Safari Ø¹Ù„Ù‰ Mac Ù…Ø«Ù„Ø§Ù‹ â†’ HLS Ù…Ø¹ retry
        retryPlay(hlsUrl, false);
    } else {
        // Chrome / Android WebView â†’ FLV
        retryPlay(flvUrl, true);
    }
}

/* ===================== CAMERA FILTER ===================== */
function setCam(c){
    cameraFilter = c;
    btnC1.classList.toggle("active", c===1);
    btnC2.classList.toggle("active", c===2);
    btnCAll.classList.toggle("active", c==="all");
    loadFiles();
}

/* ===================== DEVICE DROPDOWN ===================== */
async function loadDeviceDropdown() {
    await loadDeviceNames(); // Ù…Ù† Ø´ÙŠØª Devices

    const params = new URLSearchParams(window.location.search);
    const decoded = params.get("params")
        ? JSON.parse(decodeURIComponent(params.get("params")))
        : {};

    const ids = (decoded["ds16.devices"] || "")
                    .split(",")
                    .map(x => x.trim())
                    .filter(Boolean);

    deviceSelect.innerHTML = "";

    ids.forEach(id => {
        // Ù†Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ© ÙÙŠ Ø´ÙŠØª Devices
        if (!deviceNames[id]) return;
        const name = deviceNames[id];
        deviceSelect.innerHTML += `<option value="${id}">${name}</option>`;
    });

    if (!deviceSelect.innerHTML.trim()){
        deviceSelect.innerHTML = `<option>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¬Ù‡Ø²Ø© Ù…Ø¹Ø±ÙØ©</option>`;
    }
}

/* ===================== POPULATE HOURS ===================== */
for (let h=0; h<24; h++){
    const hh = h.toString().padStart(2,"0");
    hourPicker.innerHTML += `<option value="${hh}">${hh}:00</option>`;
}

/* ===================== LOAD FILES FROM MAIN SHEET ===================== */
async function loadFiles(){
    const id   = deviceSelect.value;
    const date = datePicker.value;
    const hour = hourPicker.value;
    const fileList = document.getElementById("fileList");

    if (!id || !date || !hour){
        fileList.innerHTML = "<i>Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø³Ø§Ø¹Ø©...</i>";
        return;
    }

    fileList.innerHTML = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

    const sql = `select * where G=${id} order by A desc`;
    const url = FILE_SHEET_URL + "&tq=" + encodeURIComponent(sql);

    try {
        const text = await (await fetch(url)).text();
        const json = JSON.parse(text.substring(47).slice(0,-2));
        const rows = json.table.rows || [];

        let output = [];

        rows.forEach(r => {
            const c = r.c;
            if (!c) return;

            const raw = c[0].f; // "MM/DD/YYYY HH:mm:ss"
            const [mdy, t] = raw.split(" ");
            const [M,D,Y]  = mdy.split("/");

            const d2 = `${Y}-${M.padStart(2,"0")}-${D.padStart(2,"0")}`;
            const hh = t.split(":")[0].padStart(2,"0");

            if (d2 !== date || hh !== hour) return;

            // ÙƒØ§Ù…ÙŠØ±Ø§ Ø±Ù‚Ù…ØŸ
            const camVal = c[4]?.v;
            if (cameraFilter !== "all" && String(camVal) !== String(cameraFilter)) return;

            output.push({
                time: t,
                filename: c[2].v,
                deviceId: c[6].v
            });
        });

        if (!output.length){
            fileList.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ø§Ø¹Ø©.";
            return;
        }

        fileList.innerHTML = "";
        output.forEach(v => {
            fileList.innerHTML += `
                <div class="file-item" onclick="playVideo('${v.filename}','${v.deviceId}')">
                    <div class="time-label">${v.filename}</div>
                    <b>${v.time}</b>
                </div>
            `;
        });

    } catch(err){
        console.error(err);
        fileList.innerHTML = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
    }
}

/* ===================== INIT ===================== */
loadDeviceDropdown();
</script>

</body>
</html>
