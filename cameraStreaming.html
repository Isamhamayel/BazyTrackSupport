<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>BazyGo â€“ Video Player</title>

<!-- HLS.JS -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
  body { margin:0; font-family:Arial; background:#f2f2f2; }
  .container { display:flex; height:100vh; }

  .left {
    width:45%; background:white; border-right:2px solid #ddd;
    padding:15px; overflow-y:auto; box-sizing:border-box;
  }

  .right {
    width:55%; padding:20px; box-sizing:border-box;
    background:#fafafa;
  }

  .file {
    background:#f9f9f9; padding:10px; margin:6px 0;
    border-radius:6px; border:1px solid #ddd; cursor:pointer;
  }
  .file:hover { background:#ececec; }

  .time-label { font-size:12px; color:#666; }

  .cam-btn {
    padding:4px 10px; border:1px solid #999; margin-right:6px; border-radius:4px;
    cursor:pointer; font-size:13px;
  }
  .cam-btn.active { background:#2196F3; color:white; }

  .controls select,
  .controls input[type="date"] {
    padding:5px; margin-right:8px; margin-bottom:10px;
  }
</style>

</head>

<body>

<div class="container">

  <!-- LEFT SIDE -->
  <div class="left">
    <h3>ğŸ“ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h3>

    <div class="controls">
      <label>Ø§Ù„Ø¬Ù‡Ø§Ø²:</label>
      <select id="deviceSelect" onchange="loadFiles()"></select>

      <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
      <input type="date" id="datePicker" onchange="loadFiles()">

      <label>Ø§Ù„Ø³Ø§Ø¹Ø©:</label>
      <select id="hourPicker" onchange="loadFiles()"></select>
    </div>

    <div>
      <span id="c1" class="cam-btn active" onclick="setCam(1)">ÙƒØ§Ù…ÙŠØ±Ø§ 1</span>
      <span id="c2" class="cam-btn" onclick="setCam(2)">ÙƒØ§Ù…ÙŠØ±Ø§ 2</span>
      <span id="cAll" class="cam-btn" onclick="setCam('all')">Ø§Ù„ÙƒÙ„</span>
    </div>

    <hr>

    <div id="fileList"><i>Ø§Ø®ØªØ± Ø§Ù„ÙÙ„Ø§ØªØ±...</i></div>

  </div>

  <!-- RIGHT SIDE -->
  <div class="right">
    <h3>ğŸ¥ Ø§Ù„Ù…Ø´ØºÙ‘Ù„</h3>
    <video id="player" width="100%" height="480" controls muted playsinline style="background:black;"></video>
  </div>

</div>


<script>
/* ------------------------------------------------------------
   CONFIG
------------------------------------------------------------ */
const SHEET_ID = "1GjVH6jlTGf7BEBqld0GEX1yMqUgfQc235g64CWdNyUM";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwwI70vwtzhZtzChTG7WzF-UvQIHm0z2iXNH70wYzB0vjgodvsT3ciHcaN0MohSmeMW/exec";
const STREAM_URL = "https://streaming.bazytrack.jo/live/0/";

/* ============================================================
   STATE
============================================================ */
let cameraFilter = 1;

/* ============================================================
   BUILD HOURS LIST
============================================================ */
const hourPicker = document.getElementById("hourPicker");
for (let h = 0; h < 24; h++) {
  const hh = h.toString().padStart(2, "0");
  const opt = document.createElement("option");
  opt.value = hh;
  opt.textContent = hh + ":00";
  hourPicker.appendChild(opt);
}

/* ============================================================
   CAMERA SELECT
============================================================ */
function setCam(c) {
  cameraFilter = c;

  document.getElementById("c1").classList.toggle("active", c === 1);
  document.getElementById("c2").classList.toggle("active", c === 2);
  document.getElementById("cAll").classList.toggle("active", c === "all");

  loadFiles();
}

/* ============================================================
   READ DEVICES FROM URL PARAMS
============================================================ */
const params = new URLSearchParams(window.location.search);
const devicesJSON = params.get("params");
const decoded = devicesJSON ? JSON.parse(decodeURIComponent(devicesJSON)) : {};
const deviceList = decoded["ds16.devices"] ? decoded["ds16.devices"].split(",") : [];

const deviceSelect = document.getElementById("deviceSelect");
deviceList.forEach(id => {
  id = id.trim();
  if (!id) return;
  const opt = document.createElement("option");
  opt.value = id;
  opt.textContent = "Device " + id;
  deviceSelect.appendChild(opt);
});

/* ============================================================
   LOAD FILES
============================================================ */
async function loadFiles() {

  const deviceId = deviceSelect.value;
  const dateSel  = document.getElementById("datePicker").value;
  const hourSel  = document.getElementById("hourPicker").value;

  const fileList = document.getElementById("fileList");

  if (!deviceId || !dateSel || !hourSel) {
    fileList.innerHTML = "Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ ÙˆØ§Ù„Ø³Ø§Ø¹Ø©.";
    return;
  }

  const sql = `select * where G=${deviceId} order by A desc`;
  const url = SHEET_URL + "&tq=" + encodeURIComponent(sql);

  fileList.innerHTML = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

  try {
    const res = await fetch(url);
    const txt = await res.text();
    const json = JSON.parse(txt.substring(47).slice(0, -2));

    const rows = json.table.rows || [];
    const out = [];

    rows.forEach(r => {
      const cols = r.c;
      if (!cols) return;

      const raw = cols[0].f;
      const [mdy, time] = raw.split(" ");
      const [M, D, Y] = mdy.split("/");

      const yyyy_mm_dd = `${Y}-${M.padStart(2,"0")}-${D.padStart(2,"0")}`;
      const hh = time.split(":")[0].padStart(2,"0");

      if (yyyy_mm_dd !== dateSel) return;
      if (hh !== hourSel) return;

      const camVal = cols[4]?.v;
      if (cameraFilter !== "all" && String(camVal) !== String(cameraFilter)) return;

      out.push({
        time,
        filename: cols[2].v,
        imei: cols[1].f,
        deviceId: cols[6].v
      });
    });

    if (!out.length) {
      fileList.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ø§Ø¹Ø©.";
      return;
    }

    fileList.innerHTML = "";
    out.forEach(v => {
      const div = document.createElement("div");
      div.className = "file";
      div.innerHTML = `<div class="time-label">${v.filename}</div>${v.time}`;
      div.onclick = () => playVideo(v.filename, v.deviceId, v.imei);
      fileList.appendChild(div);
    });

  } catch (e) {
    fileList.innerHTML = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
    console.error(e);
  }
}

/* ============================================================
   PLAY VIDEO (HLS)
============================================================ */
  function stopPlayer() {
  const video = document.getElementById("player");

  if (window.hls) {
    try { window.hls.destroy(); } catch(e) {}
    window.hls = null;
  }

  video.pause();
  video.removeAttribute("src");
  video.load();
}

function playVideo(fname, deviceId, imei) {

   // ALWAYS STOP OLD STREAM FIRST
  stopPlayer();
  
  // 1) Send command to camera
  fetch(`${WEBAPP_URL}?type=playback&deviceId=${deviceId}&fileName=${fname}`);

  // 2) Expected HLS URL
  const stream = `https://streaming.bazytrack.jo/live/0/${imei}.m3u8`;
  const video = document.getElementById("player");

  // 3) Start checking if stream is ready
  checkStreamReady(stream, video, 0);
}

function checkStreamReady(url, video, attempts) {

  // Maximum waiting time = 30 seconds (15 attempts)
  if (attempts > 15) {
    console.error("Stream not ready after 30 seconds.");
    alert("âš  Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ø¨Ø¹Ø¯. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
    return;
  }

  fetch(url, { method: 'HEAD' })
    .then(res => {
      if (res.ok) {
        console.log("Stream READY. Loading...");
        startHLS(url, video);
      } else {
        console.log("Stream not ready yet, retrying...");
        setTimeout(() => checkStreamReady(url, video, attempts + 1), 2000);
      }
    })
    .catch(() => {
      console.log("Stream not ready yet, retrying...");
      setTimeout(() => checkStreamReady(url, video, attempts + 1), 2000);
    });
}

function startHLS(url, video) {

  if (Hls.isSupported()) {
    if (window.hls) window.hls.destroy();

    window.hls = new Hls();
    window.hls.loadSource(url);
    window.hls.attachMedia(video);

    window.hls.on(Hls.Events.MANIFEST_PARSED, function () {
      video.play().catch(err => console.log("Autoplay error:", err));
    });

  } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
    video.src = url;
    video.play();
  }
}

</script>

</body>
</html>
