<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>BazyGo â€“ Video Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- HLS.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<!-- FLV.js -->
<script src="https://cdn.jsdelivr.net/npm/flv.js/dist/flv.min.js"></script>

<style>
  * { box-sizing: border-box; }
  body { margin:0; font-family:Arial; background:#f2f2f2; }

  /* MOBILE LAYOUT */
  .page {
    display:flex;
    flex-direction:column;
    height:100vh;
  }

  .top-panel {
    background:white;
    padding:12px;
    border-bottom:2px solid #ddd;
  }

  .file-panel {
    flex:1 1 auto;
    overflow-y:auto;
    padding:12px;
    background:#fafafa;
  }

  #player {
    width:100%;
    height:auto;
    background:black;
    max-height:60vh;
    border-radius:8px;
  }

  .controls {
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
    margin-bottom:8px;
  }

  .controls select,
  .controls input[type="date"] {
    padding:5px;
    font-size:13px;
  }

  .cam-buttons {
    margin-bottom:10px;
  }

  .cam-btn {
    padding:4px 10px;
    border:1px solid #888;
    margin-left:6px;
    border-radius:4px;
    cursor:pointer;
    font-size:13px;
  }
  .cam-btn.active {
    background:#2196F3;
    color:white;
  }

  .file {
    background:#fff;
    padding:10px;
    margin:6px 0;
    border-radius:6px;
    border:1px solid #ddd;
    cursor:pointer;
  }

  /* DESKTOP LAYOUT */
  @media (min-width: 768px) {
    .page { flex-direction:row; }
    .top-panel {
      flex:0 0 55%;
      height:100vh;
      overflow-y:auto;
      padding:20px;
      border-left:2px solid #ddd;
    }
    .file-panel {
      flex:0 0 45%;
      height:100vh;
      overflow-y:auto;
      padding:20px;
      border-right:2px solid #ddd;
      background:white;
    }
    #player {
      height:480px;
      max-height:480px;
    }
  }

  /* LOADING OVERLAY */
  #loadingOverlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(255,255,255,0.85);
    padding: 20px;
    text-align: center;
    font-size: 16px;
    display: none;
  }

  /* Spinner */
  .spinner {
    border: 4px solid #ccc;
    border-top: 4px solid #2196F3;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    margin: 10px auto;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    100% { transform: rotate(360deg); }
  }

</style>
</head>

<body>

<div class="page">

  <div class="top-panel" style="position:relative">
    <h3>ğŸ¥ Ø§Ù„Ù…Ø´ØºÙ‘Ù„</h3>

    <div id="loadingOverlay">
      <div class="spinner"></div>
      Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...
    </div>

    <div class="controls">
      <label>Ø§Ù„Ø¬Ù‡Ø§Ø²:</label>
      <select id="deviceSelect" onchange="loadFiles()"></select>

      <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
      <input type="date" id="datePicker" onchange="loadFiles()">

      <label>Ø§Ù„Ø³Ø§Ø¹Ø©:</label>
      <select id="hourPicker" onchange="loadFiles()"></select>
    </div>

    <div class="cam-buttons">
      <span id="c1" class="cam-btn active" onclick="setCam(1)">ÙƒØ§Ù…ÙŠØ±Ø§ 1</span>
      <span id="c2" class="cam-btn" onclick="setCam(2)">ÙƒØ§Ù…ÙŠØ±Ø§ 2</span>
      <span id="cAll" class="cam-btn" onclick="setCam('all')">Ø§Ù„ÙƒÙ„</span>
    </div>

    <video id="player" controls muted playsinline></video>
  </div>

  <div class="file-panel">
    <h4>ğŸ“ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h4>
    <div id="fileList"><i>Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ ÙˆØ§Ù„Ø³Ø§Ø¹Ø©...</i></div>
  </div>

</div>

<script>
/* CONFIG */
const SHEET_ID = "1GjVH6jlTGf7BEBqld0GEX1yMqUgfQc235g64CWdNyUM";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwwI70vwtzhZtzChTG7WzF-UvQIHm0z2iXNH70wYzB0vjgodvsT3ciHcaN0MohSmeMW/exec";

let cameraFilter = 1;

/* HOURS */
for (let h=0; h<24; h++){
  const hh = h.toString().padStart(2, "0");
  hourPicker.innerHTML += `<option value="${hh}">${hh}:00</option>`;
}

/* CAMERA SELECTION */
function setCam(c) {
  cameraFilter = c;
  c1.classList.toggle("active", c === 1);
  c2.classList.toggle("active", c === 2);
  cAll.classList.toggle("active", c === "all");
  loadFiles();
}

/* READ DEVICES */
const params = new URLSearchParams(window.location.search);
const decoded = params.get("params") ? JSON.parse(decodeURIComponent(params.get("params"))) : {};
(decoded["ds16.devices"] || "")
  .split(",")
  .map(d => d.trim())
  .filter(Boolean)
  .forEach(id => deviceSelect.innerHTML += `<option value="${id}">Device ${id}</option>`);

/* LOAD FILES */
async function loadFiles() {
  const id = deviceSelect.value;
  const date = datePicker.value;
  const hour = hourPicker.value;
  const fileList = document.getElementById("fileList");

  if (!id || !date || !hour) {
    fileList.innerHTML = "Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ ÙˆØ§Ù„Ø³Ø§Ø¹Ø©.";
    return;
  }

  fileList.innerHTML = "Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

  const sql = `select * where G=${id} order by A desc`;
  const url = SHEET_URL + "&tq=" + encodeURIComponent(sql);

  try {
    const txt = await (await fetch(url)).text();
    const json = JSON.parse(txt.substring(47).slice(0, -2));
    const rows = json.table.rows || [];

    const out = [];

    for (const r of rows) {
      const c = r.c;
      if (!c) continue;

      const raw = c[0].f;
      const [mdy, t] = raw.split(" ");
      const [M, D, Y] = mdy.split("/");

      const d2 = `${Y}-${M.padStart(2,"0")}-${D.padStart(2,"0")}`;
      const hh = t.split(":")[0].padStart(2,"0");

      if (d2 !== date) continue;
      if (hh !== hour) continue;

      if (cameraFilter !== "all" && String(c[4]?.v) !== String(cameraFilter)) continue;

      out.push({
        time: t,
        filename: c[2].v,
        imei: c[1].f,
        deviceId: c[6].v
      });
    }

    if (!out.length) {
      fileList.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ø§Ø¹Ø©.";
      return;
    }

    fileList.innerHTML = "";
    out.forEach(v => {
      fileList.innerHTML += `
        <div class="file" onclick="playVideo('${v.filename}', '${v.deviceId}', '${v.imei}')">
          <div class="time-label">${v.filename}</div>${v.time}
        </div>`;
    });

  } catch (err) {
    fileList.innerHTML = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
  }
}

/* ==============================================
   HLS + FLV PLAYER
================================================= */

function showLoading(msg=true){
  const o = document.getElementById("loadingOverlay");
  o.style.display = msg ? "block" : "none";
}

function stopPlayer() {
  const v = document.getElementById("player");

  if (window.hls) { try{ window.hls.destroy(); }catch(e){} window.hls = null; }
  if (window.flvPlayer) { try{ window.flvPlayer.destroy(); }catch(e){} window.flvPlayer = null; }

  v.pause();
  v.removeAttribute("src");
  v.load();
}

function playVideo(fname, deviceId, imei) {

  stopPlayer();
  showLoading(true);

  fetch(`${WEBAPP_URL}?type=playback&deviceId=${deviceId}&fileName=${fname}`);

  const base = `https://streaming.bazytrack.jo/live/0/`;
  const m3u8 = `${base}${imei}.m3u8`;

  checkHLSReady(base, imei, m3u8, 0);
}

/* Check m3u8 + ts segment */
async function checkHLSReady(base, imei, m3u8, attempt) {

  if (attempt > 60) {  // 60 seconds max
    playFLV(imei);
    return;
  }

  try {
    const res = await fetch(m3u8);
    if (!res.ok) return setTimeout(() => checkHLSReady(base, imei, m3u8, attempt+1), 1000);

    const txt = await res.text();
    const match = txt.match(/(seg-\d+\.ts)/);

    if (!match) return setTimeout(() => checkHLSReady(base, imei, m3u8, attempt+1), 1000);

    const tsUrl = base + match[1];
    const seg = await fetch(tsUrl, { method:"HEAD" });

    if (seg.ok) {
      startPlayback(m3u8, imei);
      return;
    }

  } catch(e){}

  setTimeout(() => checkHLSReady(base, imei, m3u8, attempt+1), 1000);
}

function startPlayback(m3u8, imei) {
  const video = document.getElementById("player");
  let started = false;

  /* Native HLS (Safari/iPhone) */
  if (video.canPlayType("application/vnd.apple.mpegurl")) {
    video.src = m3u8;
    video.play().then(() => {
      started = true;
      showLoading(false);
    }).catch(() => playFLV(imei));
    return;
  }

  /* Hls.js */
  if (Hls.isSupported()) {

    if (window.hls) window.hls.destroy();

    window.hls = new Hls({
      maxBufferLength:5,
      maxMaxBufferLength:10
    });

    window.hls.loadSource(m3u8);
    window.hls.attachMedia(video);

    window.hls.on(Hls.Events.MANIFEST_PARSED, () => {
      video.play().then(() => {
        started = true;
        showLoading(false);
      }).catch(() => playFLV(imei));
    });

    setTimeout(() => {
      if (!started) playFLV(imei);
    }, 2000);

    return;
  }

  playFLV(imei);
}

/* FLV fallback */
function playFLV(imei) {
  const video = document.getElementById("player");

  stopPlayer();

  const flvUrl = `wss://streaming.bazytrack.jo/live/${imei}.flv`;

  if (flvjs.isSupported()) {
    window.flvPlayer = flvjs.createPlayer({
      type: "flv",
      url: flvUrl
    });

    window.flvPlayer.attachMediaElement(video);
    window.flvPlayer.load();
    window.flvPlayer.play();

    showLoading(false);

    /* Auto-reconnect if FLV stops */
    window.flvPlayer.on('error', () => {
      console.log("FLV error, reconnecting...");
      setTimeout(() => playFLV(imei), 2000);
    });
  }
}

</script>

</body>
</html>
