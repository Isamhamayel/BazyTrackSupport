<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>BazyGo â€“ Video Playback</title>

<style>
  body { font-family: Arial; background:#f7f7f7; padding:20px; }
  .file { padding:10px; margin-bottom:5px; background:white; border-radius:5px;
          border:1px solid #ddd; cursor:pointer; }
  .file:hover { background:#eee; }
  .device-title { margin-top:25px; font-weight:bold; font-size:18px; }
  .cam-btn { padding:6px 12px; border:1px solid #888; margin-right:6px;
             border-radius:4px; cursor:pointer; display:inline-block; }
  .cam-btn.active { background:#007bff; color:white; border-color:#0056b3; }
  select, input[type="date"] { padding:4px 6px; margin-right:8px; }
</style>

</head>
<body>

<h2>ðŸ“¹ Camera Playback</h2>

<p>
  <label><b>Device:</b></label>
  <select id="deviceSelect" onchange="loadFiles()">
    <option value="">-- Select device --</option>
  </select>

  <label><b>Date:</b></label>
  <input type="date" id="datePicker" onchange="loadFiles()" />

  <label><b>Hour:</b></label>
  <select id="hourSelect" onchange="loadFiles()">
    <option value="">-- Hour --</option>
  </select>
</p>

<div>
  <span id="cam1" class="cam-btn active" onclick="setCamera(1)">Camera 1</span>
  <span id="cam2" class="cam-btn" onclick="setCamera(2)">Camera 2</span>
  <span id="camAll" class="cam-btn" onclick="setCamera('all')">All</span>
</div>

<p id="info"></p>

<div id="fileList"><i>Select device, date, and hour.</i></div>

<h3>Player</h3>
<video id="player" width="700" controls></video>

<script>

const SHEET_ID = "1GjVH6jlTGf7BEBqld0GEX1yMqUgfQc235g64CWdNyUM";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
const WEBAPP_URL = "YOUR_WEBAPP_URL";
const MEDIA_BASE_URL = "YOUR_MEDIA_BASE_URL";

let cameraFilter = 1;

// Hour dropdown
const hourSelect = document.getElementById("hourSelect");
for (let h = 0; h < 24; h++) {
  const hh = h.toString().padStart(2,'0');
  const opt = document.createElement("option");
  opt.value = hh;
  opt.textContent = hh + ":00";
  hourSelect.appendChild(opt);
}

// Camera buttons
function setCamera(cam) {
  cameraFilter = cam;
  document.getElementById("cam1").classList.toggle("active", cam === 1);
  document.getElementById("cam2").classList.toggle("active", cam === 2);
  document.getElementById("camAll").classList.toggle("active", cam === "all");
  loadFiles();
}

// Device list from params
const urlParams = new URLSearchParams(window.location.search);
const rawParams = urlParams.get("params");
const decoded = JSON.parse(decodeURIComponent(rawParams));
const deviceList = decoded["ds16.devices"].split(",").map(x => x.trim());

const deviceSelect = document.getElementById("deviceSelect");
deviceList.forEach(id => {
  const opt = document.createElement("option");
  opt.value = id;
  opt.textContent = "Device " + id;
  deviceSelect.appendChild(opt);
});

// MAIN LOAD FUNCTION
async function loadFiles() {

  const deviceId = deviceSelect.value;
  const dateVal  = document.getElementById("datePicker").value;
  const hourVal  = document.getElementById("hourSelect").value;

  const fileList = document.getElementById("fileList");

  if (!deviceId || !dateVal || !hourVal) {
    fileList.innerHTML = "<p>Select device, date, and hour.</p>";
    return;
  }

  // Query only device (FAST AND CORRECT)
  const query = `select * where G = ${deviceId} order by A desc`;
  const url = SHEET_URL + "&tq=" + encodeURIComponent(query);

  fileList.innerHTML = "<p>Loading...</p>";

  const resp = await fetch(url);
  const txt  = await resp.text();
  const json = JSON.parse(txt.substring(47).slice(0, -2));
  let rows = (json.table.rows || []).map(r => r.c);

  // Filter by camera
  rows = rows.filter(r => {
    const cam = String(r[4].v);
    return cameraFilter === "all" || cam === String(cameraFilter);
  });

  // Convert r[0].f into real Date (Amman time)
  rows = rows.filter(r => {
    const dt = new Date(r[0].f.replace(" ", "T"));
    const amman = new Date(dt.getTime() + (3 * 3600000)); // UTC+3
    const yyyy = amman.toISOString().substring(0,10);
    const hh   = amman.getHours().toString().padStart(2,'0');

    return (yyyy === dateVal && hh === hourVal);
  });

  if (rows.length === 0) {
    fileList.innerHTML = "<p>No videos found.</p>";
    return;
  }

  // Render rows
  fileList.innerHTML = "";
  rows.forEach(r => {
    const div = document.createElement("div");
    div.className = "file";
    div.textContent = r[2].v;
    div.onclick = () => playVideo(r);
    fileList.appendChild(div);
  });
}

function playVideo(row) {
  const deviceId = row[6].v;
  const filename = row[2].v;

  fetch(`${WEBAPP_URL}?deviceId=${deviceId}&filename=${filename}`);
  document.getElementById("player").src = MEDIA_BASE_URL + filename;
}

</script>

</body>
</html>
