<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>BazyGo â€“ Video Player</title>

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f2f2f2;
  }

  .container {
    display: flex;
    height: 100vh;
  }

  .left {
    width: 45%;
    background: #ffffff;
    border-right: 2px solid #ddd;
    padding: 15px;
    overflow-y: auto;
  }

  .right {
    width: 55%;
    padding: 20px;
    background: #f7f7f7;
    box-sizing: border-box;
  }

  .file {
    background: #f9f9f9;
    padding: 8px 10px;
    margin: 6px 0;
    border-radius: 6px;
    border: 1px solid #ddd;
    cursor: pointer;
  }

  .file:hover {
    background: #ececec;
  }

  .time-label {
    font-size: 12px;
    color: #666;
    margin-bottom: 2px;
  }

  .cam-btn {
    padding: 4px 10px;
    border: 1px solid #999;
    margin-right: 6px;
    border-radius: 4px;
    cursor: pointer;
  }

  .cam-btn.active {
    background: #2196F3;
    color: white;
  }

  .controls select,
  .controls input[type="date"] {
    padding: 4px 6px;
    margin-right: 8px;
    margin-bottom: 8px;
  }

  #debug {
    margin-top: 10px;
    font-size: 11px;
    color: #999;
  }
</style>

</head>
<body>

<div class="container">

  <!-- LEFT: FILE LIST -->
  <div class="left">
    <h3>ğŸ“ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h3>

    <div class="controls">
      <label>Ø§Ù„Ø¬Ù‡Ø§Ø²:</label>
      <select id="deviceSelect" onchange="loadFiles()"></select>

      <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
      <input type="date" id="datePicker" onchange="loadFiles()">

      <label>Ø§Ù„Ø³Ø§Ø¹Ø©:</label>
      <select id="hourPicker" onchange="loadFiles()"></select>
    </div>

    <div>
      <span id="c1" class="cam-btn active" onclick="setCam(1)">ÙƒØ§Ù…ÙŠØ±Ø§ 1</span>
      <span id="c2" class="cam-btn" onclick="setCam(2)">ÙƒØ§Ù…ÙŠØ±Ø§ 2</span>
      <span id="cAll" class="cam-btn" onclick="setCam('all')">Ø§Ù„ÙƒÙ„</span>
    </div>

    <hr>

    <div id="fileList"><i>Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ ÙˆØ§Ù„Ø³Ø§Ø¹Ø©...</i></div>
    <div id="debug"></div>
  </div>

  <!-- RIGHT: PLAYER -->
  <div class="right">
    <h3>ğŸ¥ Ø§Ù„Ù…Ø´ØºÙ‘Ù„</h3>
    <video id="player" width="100%" height="480" controls style="background:#000;"></video>
  </div>

</div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©
var SHEET_ID = "1GjVH6jlTGf7BEBqld0GEX1yMqUgfQc235g64CWdNyUM";
var SHEET_URL = "https://docs.google.com/spreadsheets/d/" + SHEET_ID + "/gviz/tq?tqx=out:json";

// ØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙŠØ¯ÙŠØ§
var MEDIA_BASE_URL = "YOUR_MEDIA_URL/"; 

var cameraFilter = 1;

// ØªØ¹Ø¨Ø¦Ø© Ø³Ø§Ø¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…
var hourPicker = document.getElementById("hourPicker");
for (var h = 0; h < 24; h++) {
  var hh = h < 10 ? "0" + h : "" + h;
  var opt = document.createElement("option");
  opt.value = hh;
  opt.textContent = hh + ":00";
  hourPicker.appendChild(opt);
}

// Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª
function setCam(c) {
  cameraFilter = c;
  document.getElementById("c1").classList.toggle("active", c === 1);
  document.getElementById("c2").classList.toggle("active", c === 2);
  document.getElementById("cAll").classList.toggle("active", c === "all");
  loadFiles();
}

// Ù‚Ø±Ø§Ø¡Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ù…Ù† params
var params = new URLSearchParams(window.location.search);
var devicesJSON = params.get("params");
var decoded = devicesJSON ? JSON.parse(decodeURIComponent(devicesJSON)) : {};
var deviceList = decoded["ds16.devices"] ? decoded["ds16.devices"].split(",") : [];

var deviceSelect = document.getElementById("deviceSelect");
for (var i = 0; i < deviceList.length; i++) {
  var id = deviceList[i].trim();
  if (!id) continue;
  var opt = document.createElement("option");
  opt.value = id;
  opt.textContent = "Device " + id;
  deviceSelect.appendChild(opt);
}

// Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
async function loadFiles() {
  var deviceId = deviceSelect.value;
  var dateSel = document.getElementById("datePicker").value;   // "2025-11-26"
  var hourSel = document.getElementById("hourPicker").value;   // "09" Ù…Ø«Ù„Ø§Ù‹

  var fileList = document.getElementById("fileList");
  var debugDiv = document.getElementById("debug");

  if (!deviceId || !dateSel || !hourSel) {
    fileList.innerHTML = "Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ ÙˆØ§Ù„Ø³Ø§Ø¹Ø©.";
    debugDiv.innerHTML = "";
    return;
  }

  // Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¨Ø³ÙŠØ·: Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø·
  var sql = "select * where G = " + deviceId + " order by A desc";
  var url = SHEET_URL + "&tq=" + encodeURIComponent(sql);

  fileList.innerHTML = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
  debugDiv.innerHTML = "";

  try {
    var res = await fetch(url);
    var text = await res.text();
    var json = JSON.parse(text.substring(47).slice(0, -2));

    var rows = json.table.rows || [];
    var total = rows.length;
    var matched = 0;

    var result = [];

    for (var r = 0; r < rows.length; r++) {
      var cols = rows[r].c;
      if (!cols) continue;

      // Ù†Ø³ØªØ®Ø¯Ù… f Ù„Ø£Ù†Ù‡ ÙŠØ·Ø§Ø¨Ù‚ ÙˆÙ‚Øª Ø¹Ù…Ù‘Ø§Ù† ÙƒÙ…Ø§ ØªØ±Ø§Ù‡ ÙÙŠ Ø§Ù„Ø´ÙŠØª
      var f = cols[0].f; // "11/26/2025 9:03:52"
      if (!f) continue;

      var dt = new Date(f.replace(" ", "T")); // Ø§Ù„Ù…ØªØµÙØ­ ÙŠÙ‚Ø±Ø£Ù‡Ø§ ÙƒÙ€ local time
      if (isNaN(dt.getTime())) continue;

      var yyyy = dt.getFullYear();
      var mm = (dt.getMonth() + 1).toString().padStart(2, '0');
      var dd = dt.getDate().toString().padStart(2, '0');
      var hh = dt.getHours().toString().padStart(2, '0');

      var dateStr = yyyy + "-" + mm + "-" + dd;
      if (dateStr !== dateSel) continue;
      if (hh !== hourSel) continue;

      var camVal = cols[4] ? cols[4].v : null;
      if (cameraFilter !== "all" && String(camVal) !== String(cameraFilter)) continue;

      rows[r]._localTime = dt;
      result.push(rows[r]);
    }

    matched = result.length;

    if (!matched) {
      fileList.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ø§Ø¹Ø©.";
      debugDiv.innerHTML = "Total rows: " + total + ", matched: 0";
      return;
    }

    fileList.innerHTML = "";
    for (var j = 0; j < result.length; j++) {
      var row = result[j];
      var c = row.c;
      var filename = c[2].v;
      var t = row._localTime;
      var timeStr = t.toTimeString().substr(0, 8); // HH:MM:SS

      var div = document.createElement("div");
      div.className = "file";
      div.innerHTML = '<div class="time-label">' + timeStr + '</div>' + filename;
      (function(fname) {
        div.onclick = function() { playVideo(fname); };
      })(filename);
      fileList.appendChild(div);
    }

    debugDiv.innerHTML = "Total rows: " + total + ", matched: " + matched;

  } catch (err) {
    fileList.innerHTML = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
    debugDiv.innerHTML = "Error: " + err;
  }
}

function playVideo(filename) {
  document.getElementById("player").src = MEDIA_BASE_URL + filename;
}

</script>

</body>
</html>
