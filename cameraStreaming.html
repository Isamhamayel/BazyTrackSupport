<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>BazyGo Video Player</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f2f2f2;
}

/* Split Screen */
.container {
  display: flex;
  height: 100vh;
}

/* Left side â€“ Files */
.left {
  width: 45%;
  background: #ffffff;
  border-right: 2px solid #ddd;
  padding: 15px;
  overflow-y: scroll;
}

/* Right side â€“ Video */
.right {
  width: 55%;
  padding: 20px;
  background: #f7f7f7;
}

/* File item */
.file {
  background: #f9f9f9;
  padding: 10px;
  margin: 8px 0;
  border-radius: 6px;
  border: 1px solid #ddd;
  cursor: pointer;
}
.file:hover {
  background: #ececec;
}

/* Camera button */
.cam-btn {
  padding: 5px 12px;
  border: 1px solid #999;
  margin-right: 8px;
  border-radius: 4px;
  cursor: pointer;
}
.cam-btn.active {
  background: #2196F3;
  color: white;
}

/* Controls area */
.controls select, 
.controls input[type="date"] {
  padding: 6px;
  margin-right: 10px;
  margin-bottom: 10px;
}

.time-label {
  font-size: 13px;
  color: #666;
  margin-bottom: 3px;
}
</style>

</head>
<body>

<div class="container">
  
  <!-- LEFT SIDE (FILES) -->
  <div class="left">
    <h3>ğŸ“ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h3>

    <div class="controls">
      <label>Ø§Ù„Ø¬Ù‡Ø§Ø²:</label>
      <select id="deviceSelect" onchange="loadFiles()"></select>

      <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
      <input type="date" id="datePicker" onchange="loadFiles()">

      <label>Ø§Ù„Ø³Ø§Ø¹Ø©:</label>
      <select id="hourPicker" onchange="loadFiles()"></select>
    </div>

    <div>
      <span id="c1" class="cam-btn active" onclick="setCam(1)">ÙƒØ§Ù…ÙŠØ±Ø§ 1</span>
      <span id="c2" class="cam-btn" onclick="setCam(2)">ÙƒØ§Ù…ÙŠØ±Ø§ 2</span>
      <span id="cAll" class="cam-btn" onclick="setCam('all')">ÙƒÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª</span>
    </div>

    <hr>

    <div id="fileList"><i>Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ ÙˆØ§Ù„Ø³Ø§Ø¹Ø©...</i></div>

  </div>

  <!-- RIGHT SIDE (VIDEO PLAYER) -->
  <div class="right">
    <h3>ğŸ¥ Ø§Ù„Ù…Ø´ØºÙ‘Ù„</h3>
    <video id="player" width="100%" height="480" controls style="background:#000;"></video>
  </div>

</div>

<script>

const SHEET_ID = "1GjVH6jlTGf7BEBqld0GEX1yMqUgfQc235g64CWdNyUM";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

let cameraFilter = 1;

/* Hours dropdown */
const hourPicker = document.getElementById("hourPicker");
for (let h=0; h<24; h++){
  const opt = document.createElement("option");
  opt.value = h.toString().padStart(2,'0');
  opt.textContent = `${h.toString().padStart(2,'0')}:00`;
  hourPicker.appendChild(opt);
}

/* Cameras */
function setCam(c){
  cameraFilter = c;
  document.getElementById("c1").classList.toggle("active", c===1);
  document.getElementById("c2").classList.toggle("active", c===2);
  document.getElementById("cAll").classList.toggle("active", c==="all");
  loadFiles();
}

/* Device List from URL params */
const params = new URLSearchParams(window.location.search);
const devicesJSON = params.get("params");
const decoded = devicesJSON ? JSON.parse(decodeURIComponent(devicesJSON)) : {};
const deviceList = decoded["ds16.devices"]?.split(",") || [];

const deviceSelect = document.getElementById("deviceSelect");
deviceList.forEach(id=>{
  const opt = document.createElement("option");
  opt.value=id.trim();
  opt.textContent="Device "+id.trim();
  deviceSelect.appendChild(opt);
});

/* MAIN FUNCTION */
async function loadFiles(){

  const deviceId = deviceSelect.value;
  const dateSel = document.getElementById("datePicker").value;
  const hourSel = document.getElementById("hourPicker").value;

  if(!deviceId || !dateSel || !hourSel){
    document.getElementById("fileList").innerHTML="Ø§Ø®ØªØ± ÙƒÙ„ Ø§Ù„ÙÙ„Ø§ØªØ±.";
    return;
  }

  const sql = `select * where G=${deviceId} order by A desc`;
  const url = SHEET_URL + "&tq=" + encodeURIComponent(sql);

  const res = await fetch(url);
  const txt = await res.text();
  const json = JSON.parse(txt.substring(47).slice(0,-2));

  let rows = json.table.rows || [];
  let finalRows = [];

  rows.forEach(r=>{
    const cols = r.c;
    if(!cols) return;

    // TRUE AMMAN TIME = f
    const timeString = cols[0].f; // "11/26/2025 9:03:52"
    const amman = new Date(timeString.replace(" ", "T"));

    const y = amman.toISOString().slice(0,10);
    const h = amman.getHours().toString().padStart(2,'0');

    if(y !== dateSel) return;
    if(h !== hourSel) return;

    const cam = cols[4]?.v;
    if(cameraFilter!=="all" && String(cam)!==String(cameraFilter)) return;

    r._amman = amman; // save for display
    finalRows.push(r);
  });

  const list = document.getElementById("fileList");
  list.innerHTML="";

  if(finalRows.length===0){
    list.innerHTML="Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ø§Ø¹Ø©.";
    return;
  }

  finalRows.forEach(r=>{
    const filename = r.c[2].v;
    const timeStr  = r._amman.toTimeString().slice(0,8);

    const div = document.createElement("div");
    div.className="file";
    div.innerHTML = `<div class="time-label">${timeStr}</div>${filename}`;
    div.onclick = ()=> playVideo(filename);
    list.appendChild(div);
  });
}

function playVideo(filename){
  document.getElementById("player").src = "YOUR_MEDIA_URL/"+filename;
}

</script>

</body>
</html>
