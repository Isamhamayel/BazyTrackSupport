<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>BazyGo â€“ Video Playback</title>
  <style>
    body { font-family: Arial; background:#f7f7f7; padding:20px; }
    .file { padding:10px; margin-bottom:5px; background:white; border-radius:5px; border:1px solid #ddd; cursor:pointer; }
    .file:hover { background:#eee; }
    .device-title { margin-top:25px; font-weight:bold; font-size:18px; }
    .cam-btn { padding:6px 12px; border:1px solid #888; margin-right:6px; border-radius:4px; cursor:pointer; display:inline-block; }
    .cam-btn.active { background:#007bff; color:white; border-color:#0056b3; }
  </style>
</head>

<body>
  <h2>ðŸ“¹ Video Playback</h2>

  <p>
    <label><b>Select Date:</b></label>
    <input type="date" id="datePicker" onchange="loadFiles()" />
  </p>

  <div>
    <span id="cam1" class="cam-btn active" onclick="setCamera(1)">Camera 1</span>
    <span id="cam2" class="cam-btn" onclick="setCamera(2)">Camera 2</span>
    <span id="camAll" class="cam-btn" onclick="setCamera('all')">All Cameras</span>
  </div>

  <p id="info"></p>
  <div id="fileList"><i>Please select a date.</i></div>

  <h3>Player</h3>
  <video id="player" width="700" controls></video>

  <script>
    const SHEET_ID = "1GjVH6jlTGf7BEBqld0GEX1yMqUgfQc235g64CWdNyUM";
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwwI70vwtzhZtzChTG7WzF-UvQIHm0z2iXNH70wYzB0vjgodvsT3ciHcaN0MohSmeMW/exec";  // <-- replace with your WebApp
    let cameraFilter = 1;

    function setCamera(cam) {
      cameraFilter = cam;
      document.getElementById("cam1").classList.toggle("active", cam === 1);
      document.getElementById("cam2").classList.toggle("active", cam === 2);
      document.getElementById("camAll").classList.toggle("active", cam === "all");
      loadFiles();  // reload after camera change
    }

    // read device list from params
    const urlParams = new URLSearchParams(window.location.search);
    const rawParams = urlParams.get("params");
    if (!rawParams) {
      document.getElementById("fileList").innerHTML =
        "<p style='color:red;'>No device list provided.</p>";
      throw new Error("Missing params");
    }
    const decoded = JSON.parse(decodeURIComponent(rawParams));
    const deviceList = decoded["ds16.devices"].split(",").map(x => x.trim());

    function formatYMD(dateStr) {
      // dateStr like "2025-11-26"
      return dateStr;
    }

    async function loadFiles() {
      const sel = document.getElementById("datePicker").value;
      if (!sel) {
        document.getElementById("fileList").innerHTML = "<p>Please select a date.</p>";
        return;
      }

      const next = new Date(sel);
      next.setDate(next.getDate() + 1);
      const nextStr = next.toISOString().split("T")[0];

      // SQL Query: filter by date range AND device ID in list
      const query = `select * where A >= date '${sel}' and A < date '${nextStr}' and G in (${deviceList.map(id => "'" + id + "'").join(",")})`;
      const url = SHEET_URL + "&tq=" + encodeURIComponent(query);

      const resp = await fetch(url);
      const txt  = await resp.text();
      const json = JSON.parse(txt.substring(47).slice(0,-2));

      const rows = (json.table.rows || []).map(r => r.c);

      const listDiv = document.getElementById("fileList");
      listDiv.innerHTML = "";

      const filtered = rows.filter(r => {
        const cam = r[4] ? r[4].v : "";
        return (cameraFilter === "all" || cam === String(cameraFilter));
      });

      if (filtered.length === 0) {
        listDiv.innerHTML = "<p>No videos found.</p>";
        return;
      }

      // Build device names map
      const deviceNames = {};
      rows.forEach(r => {
        const id = r[6].v;
        deviceNames[id] = r[7] ? r[7].v : id;
      });

      document.getElementById("info").innerHTML =
        `Date: <b>${sel}</b><br>Devices: ${deviceList.map(id => deviceNames[id] || id).join(", ")}`;

      const grouped = {};
      filtered.forEach(r => {
        const d = r[6].v;
        if (!grouped[d]) grouped[d] = [];
        grouped[d].push(r);
      });

      for (const did of Object.keys(grouped)) {
        const title = document.createElement("div");
        title.className = "device-title";
        title.textContent = "ðŸ“Œ " + (deviceNames[did] || did);
        listDiv.appendChild(title);

        grouped[did].forEach(r => {
          const div = document.createElement("div");
          div.className = "file";
          div.textContent = r[2].v;  // filename
          div.onclick = () => playVideo(r);
          listDiv.appendChild(div);
        });
      }
    }

    function playVideo(r) {
      const deviceId = r[6].v;
      const filename = r[2].v;

      fetch(`${WEBAPP_URL}?deviceId=${deviceId}&filename=${filename}`);

      const fileUrl = "https://bazymedia.treesal.com/uploads/" + filename;
      document.getElementById("player").src = fileUrl;
    }
  </script>
</body>
</html>
