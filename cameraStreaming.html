<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>BazyGo Video Player</title>
<style>
body { font-family: Arial; }
.file { background:#f2f2f2; padding:8px; margin:6px 0; cursor:pointer; border-radius:4px; }
.file:hover { background:#e0e0e0; }
.cam-btn { padding:4px 10px; border:1px solid #888; margin-right:5px; cursor:pointer; }
.cam-btn.active { background:#2196F3; color:white; }
</style>
</head>
<body>

<h3>Camera Streaming</h3>

<label>Device:</label>
<select id="deviceSelect" onchange="loadFiles()"></select>

<label>Date:</label>
<input type="date" id="datePicker" onchange="loadFiles()">

<label>Hour:</label>
<select id="hourPicker" onchange="loadFiles()"></select>

<div>
  <span id="c1" class="cam-btn active" onclick="setCam(1)">Camera 1</span>
  <span id="c2" class="cam-btn" onclick="setCam(2)">Camera 2</span>
  <span id="cAll" class="cam-btn" onclick="setCam('all')">All</span>
</div>

<hr>

<div id="fileList">Select filters.</div>

<video id="player" width="640" controls></video>

<script>

const SHEET_ID = "1GjVH6jlTGf7BEBqld0GEX1yMqUgfQc235g64CWdNyUM";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
let cameraFilter = 1;

// Populate hours
const hourPicker = document.getElementById("hourPicker");
for (let h=0; h<24; h++){
  const opt = document.createElement("option");
  opt.value = h.toString().padStart(2,'0');
  opt.textContent = h.toString().padStart(2,'0')+":00";
  hourPicker.appendChild(opt);
}

// Load device list from URL parameter
const params = new URLSearchParams(window.location.search);
const devicesJSON = params.get("params");
const decoded = devicesJSON ? JSON.parse(decodeURIComponent(devicesJSON)) : {};
const deviceList = decoded["ds16.devices"]?.split(",") || [];

const deviceSelect = document.getElementById("deviceSelect");
deviceList.forEach(id=>{
  const opt = document.createElement("option");
  opt.value=id.trim();
  opt.textContent="Device "+id.trim();
  deviceSelect.appendChild(opt);
});

// Camera filter
function setCam(c){
  cameraFilter = c;
  document.getElementById("c1").classList.toggle("active", c===1);
  document.getElementById("c2").classList.toggle("active", c===2);
  document.getElementById("cAll").classList.toggle("active", c==="all");
  loadFiles();
}

async function loadFiles(){

  const deviceId = deviceSelect.value;
  const dateSel = document.getElementById("datePicker").value;
  const hourSel = document.getElementById("hourPicker").value;

  if(!deviceId || !dateSel || !hourSel){
    document.getElementById("fileList").innerHTML="Select all filters.";
    return;
  }

  // Only filter by device in SQL
  const query = `select * where G = ${deviceId} order by A desc`;
  const url   = SHEET_URL + "&tq=" + encodeURIComponent(query);

  const res  = await fetch(url);
  const text = await res.text();
  const json = JSON.parse(text.substring(47).slice(0,-2));

  let rows = json.table.rows || [];

  // Now filter locally based on real Google Date()
  let finalRows = rows.filter(r => {

    const cols = r.c;
    if(!cols) return false;

    const dateObj = parseGoogleDate(cols[0].v);
    if(!dateObj) return false;

    // Convert to Jordan time (UTC+3)
    const amman = new Date(dateObj.getTime() + 3*3600000);

    const y = amman.toISOString().slice(0,10);
    const h = amman.getHours().toString().padStart(2,'0');

    if(y !== dateSel) return false;
    if(h !== hourSel) return false;

    const cam = cols[4]?.v;
    if(cameraFilter!=="all" && String(cam)!==String(cameraFilter)) return false;

    return true;
  });

  if(finalRows.length===0){
    document.getElementById("fileList").innerHTML="No videos found.";
    return;
  }

  const listDiv = document.getElementById("fileList");
  listDiv.innerHTML="";

  finalRows.forEach(r=>{
    const filename = r.c[2].v;
    const div = document.createElement("div");
    div.className="file";
    div.textContent = filename;
    div.onclick = ()=> playVideo(filename);
    listDiv.appendChild(div);
  });

}

function parseGoogleDate(str){
  // Convert Date(2025,10,26,8,59,52)
  const match = /Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/.exec(str);
  if(!match) return null;
  return new Date(
    Number(match[1]), // year
    Number(match[2]), // month
    Number(match[3]), // day
    Number(match[4]), // hour
    Number(match[5]), // minute
    Number(match[6])  // second
  );
}

function playVideo(filename){
  document.getElementById("player").src = "YOUR_MEDIA_URL/"+filename;
}

</script>

</body>
</html>
