<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>BazyGo â€“ Ù…Ø´ØºÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* { box-sizing: border-box; }
body { margin:0; font-family:'Tahoma', Arial; background:#f7f7f7; color:#333; }

header {
    background:white;
    padding:15px;
    font-size:20px;
    font-weight:bold;
    border-bottom:2px solid #e2e2e2;
}

.container {
    display:flex;
    flex-direction:column;
}

.player-area {
    background:white;
    padding:12px;
    position:sticky;
    top:0;
    box-shadow:0 3px 6px rgba(0,0,0,0.1);
    z-index:100;
}

#videoPlayer {
    width:100%;
    background:black;
    border-radius:10px;
    max-height:55vh;
}

.filters {
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:10px;
}

.filters select,
.filters input[type=date] {
    padding:8px;
    border-radius:6px;
    border:1px solid #ccc;
    font-size:14px;
}

.cam-buttons {
    margin-top:10px;
}

.cam-btn {
    padding:6px 14px;
    border-radius:6px;
    border:1px solid #aaa;
    cursor:pointer;
    margin-left:8px;
    font-size:13px;
    background:#fafafa;
}
.cam-btn.active {
    background:#2196F3;
    color:white;
    border-color:#2196F3;
}

.file-list {
    padding:15px;
}

.file-item {
    background:white;
    padding:12px;
    margin-bottom:10px;
    border-radius:8px;
    border:1px solid #ddd;
    cursor:pointer;
    transition:0.15s;
}
.file-item:hover {
    background:#e9f4ff;
    border-color:#2196F3;
}

.time-label {
    font-size:12px;
    color:#666;
    margin-bottom:4px;
}

#loadingOverlay {
    position:absolute;
    top:0; left:0; right:0; bottom:0;
    background:rgba(255,255,255,0.90);
    display:none;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    border-radius:10px;
}

.spinner {
    width:34px;
    height:34px;
    border:4px solid #ccc;
    border-top:4px solid #2196F3;
    border-radius:50%;
    animation:spin 0.7s linear infinite;
}

@keyframes spin { 100% { transform:rotate(360deg); } }

@media (min-width:800px) {
    .container {
        flex-direction:row;
    }
    .player-area {
        flex:0 0 50%;
        height:100vh;
    }
    .file-list {
        flex:0 0 50%;
        height:100vh;
        overflow-y:auto;
        padding:20px;
    }
    #videoPlayer {
        height:500px;
        max-height:500px;
    }
}
</style>
</head>

<body>

<header>ğŸ¥ Ù…Ø´ØºÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª â€“ BazyGo</header>

<div class="container">

    <!-- PLAYER AREA -->
    <div class="player-area">
        <div style="position:relative;">
            <video id="videoPlayer" controls playsinline></video>

            <div id="loadingOverlay">
                <div class="spinner"></div>
                <div style="margin-top:10px;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...</div>
            </div>
        </div>

        <div class="filters">
            <select id="deviceSelect" onchange="loadFiles()"></select>
            <input type="date" id="datePicker" onchange="loadFiles()">
            <select id="hourPicker" onchange="loadFiles()"></select>
        </div>

        <div class="cam-buttons">
            <span id="btnC1" class="cam-btn active" onclick="setCam(1)">ÙƒØ§Ù…ÙŠØ±Ø§ 1</span>
            <span id="btnC2" class="cam-btn" onclick="setCam(2)">ÙƒØ§Ù…ÙŠØ±Ø§ 2</span>
            <span id="btnCAll" class="cam-btn" onclick="setCam('all')">Ø§Ù„ÙƒÙ„</span>
        </div>
    </div>

    <!-- FILE LIST -->
    <div class="file-list" id="fileList">
        <i>Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø³Ø§Ø¹Ø©...</i>
    </div>

</div>

<script>
/* ------------------------------------------
   CONFIG
--------------------------------------------*/
const SHEET_ID = "1GjVH6jlTGf7BEBqld0GEX1yMqUgfQc235g64CWdNyUM";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwwI70vwtzhZtzChTG7WzF-UvQIHm0z2iXNH70wYzB0vjgodvsT3ciHcaN0MohSmeMW/exec";

const STREAM_HOST = "streaming.bazytrack.jo";

const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
let cameraFilter = 1;

/* ------------------------------------------
   UI HELPERS
--------------------------------------------*/
function showLoading(state){
    document.getElementById("loadingOverlay").style.display = state ? "flex" : "none";
}

function stopPlayback(){
    const video = document.getElementById("videoPlayer");
    video.pause();
    video.removeAttribute("src");
    video.srcObject = null;
    video.load();
}

/* ------------------------------------------
   RETRY PLAYBACK UNTIL STREAM IS READY
--------------------------------------------*/
function retryPlay(url){
    const video = document.getElementById("videoPlayer");
    let attempts = 0;

    function tryLoad(){
        attempts++;

        // Reset before retry
        video.pause();
        video.removeAttribute("src");
        video.load();
        video.src = url;

        video.play()
        .then(() => {
            console.log("Stream ready!");
            showLoading(false);
        })
        .catch(err => {
            console.log("Retry", attempts, "stream not readyâ€¦");

            if (attempts < 30) {
                setTimeout(tryLoad, 1000);  // retry in 1 second
            } else {
                showLoading(false);
                alert("ØªØ¹Ø°Ù‘Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
            }
        });
    }

    tryLoad();
}

/* ------------------------------------------
   PLAY VIDEO (FLV or HLS)
--------------------------------------------*/
function playVideo(filename, deviceId, imei){
    stopPlayback();
    showLoading(true);

    // Tell camera to prepare playback
    fetch(`${WEBAPP_URL}?type=playback&deviceId=${deviceId}&fileName=${filename}`);

    // Build playback URL
    const url = isSafari
        ? `https://${STREAM_HOST}/live/0/${imei}.m3u8`
        : `https://${STREAM_HOST}/live/0/${imei}.flv`;

    retryPlay(url);
}

/* ------------------------------------------
   CAMERA FILTERS
--------------------------------------------*/
function setCam(c){
    cameraFilter = c;

    btnC1.classList.toggle("active", c===1);
    btnC2.classList.toggle("active", c===2);
    btnCAll.classList.toggle("active", c==="all");

    loadFiles();
}

/* ------------------------------------------
   LOAD DEVICES FROM URL PARAMS
--------------------------------------------*/
const params = new URLSearchParams(window.location.search);
const decoded = params.get("params") ? JSON.parse(decodeURIComponent(params.get("params"))) : {};

(decoded["ds16.devices"] || "")
.split(",")
.map(x=>x.trim())
.filter(Boolean)
.forEach(id=>{
    deviceSelect.innerHTML += `<option value="${id}">Ø¬Ù‡Ø§Ø² ${id}</option>`;
});

/* Populate hours */
for (let h=0; h<24; h++){
    let hh = h.toString().padStart(2,"0");
    hourPicker.innerHTML += `<option value="${hh}">${hh}:00</option>`;
}

/* ------------------------------------------
   LOAD FILE LIST FROM GOOGLE SHEET
--------------------------------------------*/
async function loadFiles(){
    const id = deviceSelect.value;
    const date = datePicker.value;
    const hour = hourPicker.value;
    const fileList = document.getElementById("fileList");

    if (!id || !date || !hour){
        fileList.innerHTML = "<i>Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø³Ø§Ø¹Ø©...</i>";
        return;
    }

    fileList.innerHTML = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

    const sql = `select * where G=${id} order by A desc`;
    const url = SHEET_URL + "&tq=" + encodeURIComponent(sql);

    try {
        const text = await (await fetch(url)).text();
        const json = JSON.parse(text.substring(47).slice(0,-2));
        const rows = json.table.rows || [];

        let output = [];

        rows.forEach(r=>{
            let c = r.c;
            if (!c) return;

            const raw = c[0].f;
            const [mdy, t] = raw.split(" ");
            const [M,D,Y] = mdy.split("/");

            const d2 = `${Y}-${M.padStart(2,"0")}-${D.padStart(2,"0")}`;
            const hh = t.split(":")[0].padStart(2,"0");

            if (d2 !== date || hh !== hour) return;

            if (cameraFilter!=="all" && String(c[4]?.v)!==String(cameraFilter)) return;

            output.push({
                time:t,
                filename:c[2].v,
                imei:c[1].f,
                deviceId:c[6].v
            });
        });

        if (!output.length){
            fileList.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ø§Ø¹Ø©.";
            return;
        }

        fileList.innerHTML = "";
        output.forEach(v=>{
            fileList.innerHTML += `
                <div class="file-item"
                     onclick="playVideo('${v.filename}','${v.deviceId}','${v.imei}')">
                    <div class="time-label">${v.filename}</div>
                    <b>${v.time}</b>
                </div>
            `;
        });

    } catch(e){
        fileList.innerHTML = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
    }
}
</script>

</body>
</html>
