<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>POI Viewer</title>

<!-- Leaflet (OSM) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- jQuery + DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- toGeoJSON -->
<script src="https://unpkg.com/@tmcw/togeojson@5.8.1/dist/togeojson.umd.js"></script>

<style>
  .tabs {
  display: flex;
  border-bottom: 1px solid #ccc;
  margin-bottom: 8px;
}

.tab {
  padding: 6px 12px;
  cursor: pointer;
  border: 1px solid #ccc;
  border-bottom: none;
  background: #f5f5f5;
  margin-right: 4px;
  border-top-left-radius: 4px;
  border-top-right-radius: 4px;
  font-size: 14px;
}

.tab.active {
  background: white;
  font-weight: bold;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

html, body {
  margin: 0;
  height: 100%;
  font-family: Arial;
}
#container {
  display: flex;
  height: 100%;
}
#sidebar {
  width: 35%;
  padding: 10px;
  overflow: auto;
}
#map {
  flex: 1;
}
.color-box {
  width: 12px;
  height: 12px;
  display: inline-block;
  margin-right: 6px;
}
button {
  margin-top: 6px;
}
@media (max-width: 768px) {
  #container { flex-direction: column; }
  #sidebar { width: 100%; height: 50%; }
  #map { height: 50%; }
}
</style>
</head>

<body>

<div id="container">
  <div id="sidebar">

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="chartTab">Ø§Ù„Ø­Ø§Ù„Ø§Øª</div>
    <div class="tab" data-tab="listTab">Ù†Ù‚Ø§Ø· Ø§Ù„ØªÙØªÙŠØ´</div>
  </div>

  <!-- Tab: Pie Chart -->
  <div id="chartTab" class="tab-content active">
    <canvas id="statusChart"
            height="110"
            style="max-width:260px;margin:10px auto;"></canvas>

    <div id="statusFilter" style="margin-top:6px;"></div>
    <button id="resetBtn">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
  </div>

  <!-- Tab: List -->
  <div id="listTab" class="tab-content">
    <table id="poiTable" class="display">
      <thead>
        <tr><th>Ù†Ù‚Ø·Ø© Ø§Ù„ØªÙØªÙŠØ´</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

  <div id="map"></div>
</div>

<script>
/* ---------------- CONFIG ---------------- */
const STATUS_CONFIG = {
  open:    { label: 'Open',    color: '#2ecc71' },
  traffic: { label: 'Traffic', color: '#f1c40f' },
  closed:  { label: 'Closed',  color: '#e74c3c' },
};

/* ---------------- MAP ---------------- */
const map = L.map('map').setView([31.95, 35.93], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: 'Â© OpenStreetMap'
}).addTo(map);

let markers = [];
let table;
let chart;
let activeStatuses = Object.keys(STATUS_CONFIG);

/* ---------------- HELPERS ---------------- */
const getKmlUrl = () => new URLSearchParams(location.search).get('kml');

const kmlUrl = getKmlUrl();
if (!kmlUrl) {
  alert('Missing ?kml= parameter');
  throw new Error('No KML URL');
}

/* ---------------- LOAD KML ---------------- */
fetch(kmlUrl)
  .then(r => r.text())
  .then(text => {
    const dom = new DOMParser().parseFromString(text, 'text/xml');
    const geo = toGeoJSON.kml(dom);

   geo.features.forEach(f => {
        const styleUrl = (f.properties.styleUrl || '').toLowerCase();
      
        let status = 'open'; // default
      
        if (styleUrl.includes('traffic')) {
          status = 'traffic';
        } else if (styleUrl.includes('closed') || styleUrl.includes('default')) {
          status = 'closed';
        } else if (styleUrl.includes('open')) {
          status = 'open';
        }
      
        f.properties.status = status;
        f.properties.color = STATUS_CONFIG[status].color;
      
        if (!f.properties.name) {
          f.properties.name = 'POI';
        }
      });


    buildMap(geo.features);
    buildTable(geo.features);
    updateAll();
  });

  // ---------------- TABS ----------------
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    // deactivate all
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    // activate selected
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');

    // fix DataTable width when shown
    if (tab.dataset.tab === 'listTab' && table) {
      setTimeout(() => table.columns.adjust(), 50);
    }
  });
});


/* ---------------- MAP ---------------- */
function buildMap(features) {
  markers = [];
  const layer = L.geoJSON(features, {
    pointToLayer: (f, latlng) => {
      const m = L.circleMarker(latlng, {
        radius: 7,
        color: f.properties.color,
        fillColor: f.properties.color,
        fillOpacity: 1
      });
      m.feature = f;
      m.bindPopup(`<b>${f.properties.name}</b><br>Status: ${STATUS_CONFIG[f.properties.status].label}`);
      markers.push(m);
      return m;
    }
  }).addTo(map);

  map.fitBounds(layer.getBounds());
}

/* ---------------- TABLE ---------------- */
function buildTable(features) {
  const tbody = $('#poiTable tbody');
  features.forEach((f, i) => {
    tbody.append(`
      <tr data-index="${i}">
        <td>
          <span class="color-box" style="background:${f.properties.color}"></span>
          ${f.properties.name}
        </td>
      </tr>
    `);
  });

  table = $('#poiTable').DataTable();

  $('#poiTable tbody').on('click', 'tr', function () {
    const m = markers[$(this).data('index')];
    map.setView(m.getLatLng(), 16);
    m.openPopup();
  });

  table.on('draw', updateAll);
}

/* ---------------- STATS ---------------- */
function getVisibleStats() {
  const stats = { open: 0, traffic: 0, closed: 0 };

  table.rows({ filter: 'applied' }).every(function () {
    const s = markers[this.index()].feature.properties.status;
    if (activeStatuses.includes(s)) stats[s]++;
  });
  return stats;
}

/* ---------------- PIE CHART ---------------- */
function buildChart(stats) {
  const statuses = Object.keys(STATUS_CONFIG);
  const labels = statuses.map(s => STATUS_CONFIG[s].label);
  const data = statuses.map(s => stats[s] || 0);
  const colors = statuses.map(s => STATUS_CONFIG[s].color);

  if (!chart) {
    chart = new Chart(document.getElementById('statusChart'), {
      type: 'pie',
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: colors,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' }
        },
        onClick: (evt, elements) => {
          if (!elements.length) return;

          const idx = elements[0].index;
          const clickedStatus = statuses[idx];

          // ğŸ” TOGGLE LOGIC
          if (
            activeStatuses.length === 1 &&
            activeStatuses[0] === clickedStatus
          ) {
            // second click â†’ show all
            activeStatuses = Object.keys(STATUS_CONFIG);
          } else {
            // first click â†’ filter
            activeStatuses = [clickedStatus];
          }

          applyFilters();
        }
      }
    });
  } else {
    chart.data.datasets[0].data = data;
    chart.update();
  }
}


/* ---------------- STATUS FILTER UI ---------------- */
function buildStatusFilter(stats) {
  const c = document.getElementById('statusFilter');
  c.innerHTML = '';
  Object.keys(STATUS_CONFIG).forEach(s => {
    c.innerHTML += `
      <label style="margin-right:10px">
        <input type="checkbox" ${activeStatuses.includes(s) ? 'checked' : ''} value="${s}">
        <span style="color:${STATUS_CONFIG[s].color}">
          ${STATUS_CONFIG[s].label} (${stats[s] || 0})
        </span>
      </label>
    `;
  });

  c.querySelectorAll('input').forEach(cb => {
    cb.onchange = () => {
      activeStatuses = [...c.querySelectorAll('input:checked')].map(i => i.value);
      applyFilters();
    };
  });
}

/* ---------------- APPLY FILTERS ---------------- */
function applyFilters() {
  markers.forEach((m, i) => {
    const visible = activeStatuses.includes(m.feature.properties.status);
    if (visible) {
      m.addTo(map);
      $(table.row(i).node()).show();
    } else {
      map.removeLayer(m);
      $(table.row(i).node()).hide();
    }
  });
  updateAll(false);
}

/* ---------------- UPDATE ALL ---------------- */
function updateAll(rebuild = true) {
  const stats = getVisibleStats();
  buildChart(stats);
  buildStatusFilter(stats);

  const visible = markers.filter(m => activeStatuses.includes(m.feature.properties.status));
  if (visible.length) {
    map.fitBounds(L.featureGroup(visible).getBounds());
  }
}

/* ---------------- RESET ---------------- */
document.getElementById('resetBtn').onclick = () => {
  activeStatuses = Object.keys(STATUS_CONFIG);
  table.search('').draw();
  applyFilters();
};
</script>

</body>
</html>
