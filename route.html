<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 600px; }
    </style>
</head>
<body>
    <h2>Click on the map to select points</h2>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Initialize the map
        var map = L.map('map').setView([48.118477, 11.539421], 13); // Default center at a location
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var points = []; // Array to store points clicked on the map
        var markers = []; // Array to store marker objects

        // Function to add points when clicking on the map
        function onMapClick(e) {
            if (points.length < 4) { // Limit the number of points to 4
                // Add the point to the array
                points.push([e.latlng.lat, e.latlng.lng]);
                
                // Add marker to the map
                var marker = L.marker(e.latlng).addTo(map);
                markers.push(marker);

                // If there are two or more points, enable route calculation
                if (points.length >= 2) {
                    getRoute();
                }
            } else {
                alert("You can only select up to 4 points.");
            }
        }

        // Add the click event to the map
        map.on('click', onMapClick);

        // Function to fetch the route from GraphHopper API
        function getRoute() {
            var url = "https://graphhopper.com/api/1/route?key=e18fd573-f742-4069-8f82-5642fae3450e"; // GraphHopper API URL

            // Prepare the points array for the JSON format (GraphHopper requires [longitude, latitude])
            var pointsParam = points.map(function(point) {
                return [point[1], point[0]]; // Reverse lat/lng order for GraphHopper API
            });

            // Construct the body payload for the API request
            var requestBody = {
                points: pointsParam, // Points in [longitude, latitude] format
                snap_preventions: ["motorway", "ferry", "tunnel"],
                details: ["road_class", "surface"],
                profile: "car",
                locale: "en",
                instructions: true,
                calc_points: true,
                points_encoded: false
            };

            // Make the API request using fetch
            fetch(url, {
                method: "POST", // POST method because we are sending data in the body
                headers: {
                    'Content-Type': 'application/json' // JSON format for the body
                },
                body: JSON.stringify(requestBody) // Convert the body to a JSON string
            })
            .then(function(response) {
                return response.json(); // Parse JSON response
            })
            .then(function(data) {
                console.log(data);
                if (data.paths && data.paths.length > 0) {
                    // Handle the route data here
                    displayRoute(data.paths[0]);
                } else {
                    alert('No route found.');
                }
            })
            .catch(function(error) {
                console.error('Error fetching route:', error);
            });
        }

        // Function to display the route on the map
        function displayRoute(routeData) {
            var routePoints = routeData.points.coordinates;
            var routePolyline = L.polyline(routePoints, {color: 'blue'}).addTo(map);
            map.fitBounds(routePolyline.getBounds()); // Adjust map view to show route

            // Display instructions on the console (optional)
            routeData.instructions.forEach(function(instruction) {
                console.log(instruction.text);
            });
        }
    </script>
</body>
</html>
