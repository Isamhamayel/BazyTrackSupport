<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Display</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <style>
        #map { height: 500px; }
        #route-info { margin-top: 20px; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="route-info"></div>

<script>
// Initialize the map
const map = L.map('map').setView([48.118477, 11.539421], 14); // Default center, zoom level

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

// Initialize arrays to hold markers and route points
let markers = [];
let points = [];

// Function to handle click event on the map to get points
map.on('click', function (e) {
    if (points.length < 8) { // Limit the number of points to 8
        points.push([e.latlng.lat, e.latlng.lng]); // Add clicked point to points array
        L.marker([e.latlng.lat, e.latlng.lng]).addTo(map); // Add a marker at the clicked location

        // If there are two or more points, trigger route calculation
        if (points.length >= 2) {
            getRoute(); // Call function to fetch route
        }
    } else {
        alert("You can only select up to 8 points.");
    }
});

// Function to fetch route from GraphHopper (POST request)
async function getRoute() {
    const url = 'https://graphhopper.com/api/1/route?key=e18fd573-f742-4069-8f82-5642fae3450e'; // Replace with your GraphHopper API key

    // Prepare the data to be sent in the body (correct format)
    const data = {
        points: points,  // Array of points, each point as [lat, lon]
        vehicle: 'car',
        type: 'json',
        locale: 'en', // You can specify a language if needed
        elevation: false // Set to true if you need elevation data
    };

    try {
        const response = await axios.post(url, data, {
            headers: {
                'Content-Type': 'application/json'
            }
        });
        displayRoutes(response.data); // Pass the response data to the display function
    } catch (error) {
        console.error('Error fetching route:', error);
    }
}

// Function to display routes and information on the map
function displayRoutes(data) {
    const routeInfoDiv = document.getElementById('route-info');
    routeInfoDiv.innerHTML = ''; // Clear any previous route info

    if (data.paths && data.paths.length > 0) {
        data.paths.forEach((path, index) => {
            const coordinates = path.points.coordinates;
            if (coordinates) {
                const latlngs = coordinates.map(c => [c[1], c[0]]); // Convert from [lon, lat] to [lat, lon]

                // Display the route on the map
                L.polyline(latlngs, { color: 'blue' }).addTo(map);

                // Add route information (distance and time)
                const distanceInKm = (path.distance / 1000).toFixed(2); // Convert meters to kilometers
                const timeInMinutes = Math.round(path.time / 60000); // Convert milliseconds to minutes
                routeInfoDiv.innerHTML += `<strong>Route ${index + 1}</strong><br>
                                           Distance: ${distanceInKm} km<br>
                                           Time: ${timeInMinutes} minutes<br><br>`;

                // Display turn-by-turn instructions
                if (path.instructions) {
                    path.instructions.forEach(instruction => {
                        routeInfoDiv.innerHTML += `<p>${instruction.text}</p>`;
                    });
                }
            }
        });
    } else {
        routeInfoDiv.innerHTML = '<p>No routes found.</p>';
    }
}
</script>

</body>
</html>
