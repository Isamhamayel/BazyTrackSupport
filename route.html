<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimized Route Display</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <style>
        #map { height: 500px; }
        #controls { margin-top: 10px; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="controls">
    <label for="route-select">Select Route:</label>
    <select id="route-select" onchange="changeRoute()"></select>
    <div id="route-info"></div>
</div>

<script>
// Initialize the map
const map = L.map('map').setView([31.95013, 35.92487], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let markers = [];
let points = [];
let polylines = [];
let allRoutes = [];

// Function to add marker with order number
function addMarker(lat, lng, index) {
    const marker = L.marker([lat, lng]).addTo(map).bindTooltip(`${index + 1}`, { permanent: true });
    markers.push(marker);
}

// Handle map clicks to select points
map.on('click', function (e) {
    if (points.length < 8) {
        points.push([e.latlng.lng, e.latlng.lat]);
        addMarker(e.latlng.lat, e.latlng.lng, points.length - 1);
        if (points.length >= 2) {
            getBestRoute();
        }
    } else {
        alert("You can only select up to 8 points.");
    }
});

// Fetch the best route using GraphHopper
async function getBestRoute() {
    const apiKey = 'e18fd573-f742-4069-8f82-5642fae3450e'; // Replace with your key
    const url = `https://graphhopper.com/api/1/route?key=${apiKey}`;

    const data = {
        points: points,
        vehicle: 'car',
        type: 'json',
        locale: 'en',
        optimize: true, // Request optimal route
        algorithm: "round_trip"
    };

    try {
        const response = await axios.post(url, data, { headers: { 'Content-Type': 'application/json' } });
        allRoutes = response.data.paths; // Store routes
        updateRouteSelection(); // Update dropdown
        displayRoute(0); // Show best route initially
    } catch (error) {
        console.error('Error fetching route:', error);
    }
}

// Update route selection dropdown
function updateRouteSelection() {
    const routeSelect = document.getElementById('route-select');
    routeSelect.innerHTML = '';
    allRoutes.forEach((_, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `Route ${index + 1}`;
        routeSelect.appendChild(option);
    });
}

// Display selected route on the map
function displayRoute(index) {
    clearPolylines();
    const route = allRoutes[index];
    const coordinates = route.points.coordinates.map(c => [c[1], c[0]]); // Convert [lon, lat] -> [lat, lon]
    
    const polyline = L.polyline(coordinates, { color: 'blue' }).addTo(map);
    polylines.push(polyline);

    updateMarkers(route.snapped_waypoints.coordinates);
    displayRouteInfo(route);
}

// Update markers with optimized order
function updateMarkers(optimizedPoints) {
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];

    optimizedPoints.forEach((point, index) => {
        addMarker(point[1], point[0], index);
    });
}

// Display route info and savings
function displayRouteInfo(route) {
    const distanceKm = (route.distance / 1000).toFixed(2);
    const timeMin = Math.round(route.time / 60000);
    const fuelSaved = (distanceKm * 0.1).toFixed(2); // Example: Assume 10% fuel saving
    const timeSaved = Math.round(timeMin * 0.15); // Example: Assume 15% time saving

    document.getElementById('route-info').innerHTML = `
        <strong>Optimized Route:</strong><br>
        Distance: ${distanceKm} km<br>
        Time: ${timeMin} min<br>
        Fuel Saved: ${fuelSaved} L<br>
        Time Saved: ${timeSaved} min
    `;
}

// Handle route selection change
function changeRoute() {
    const selectedIndex = document.getElementById('route-select').value;
    displayRoute(parseInt(selectedIndex));
}

// Clear previous polylines
function clearPolylines() {
    polylines.forEach(polyline => map.removeLayer(polyline));
    polylines = [];
}
</script>

</body>
</html>
