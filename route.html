<!DOCTYPE html>
<html>
<head>
    <title>Select Points and Display Route</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
</head>
<body>
    <div id="map" style="width: 100%; height: 600px;"></div>
    <button id="display-route" style="margin: 10px; padding: 10px;">Display Route</button>
    <p id="route-info">Click on the map to select points, then click the "Display Route" button to show the route.</p>

    <script>
        var map = L.map('map').setView([31.963158, 35.930359], 10); // Default: Amman, Jordan

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        var points = []; // Store the selected points
        var markers = []; // Store markers
        var routeLayer; // Store the route layer

        // Function to add marker
        function addMarker(latlng) {
            var marker = L.marker(latlng).addTo(map);
            markers.push(marker);
        }

        // Function to display the route between multiple points
        function displayRoute() {
            if (points.length < 2) {
                alert("Please select at least two points.");
                return;
            }

            // Clear existing route if present
            if (routeLayer) {
                map.removeLayer(routeLayer);
            }

            // Debugging: Check if points are being passed correctly
            console.log("Selected points: ", points);

            // Fetch the route from GraphHopper
            var apiKey = "e18fd573-f742-4069-8f82-5642fae3450e"; // Your GraphHopper API Key
            var pointsString = points.map(function(point) {
                return point[0] + "," + point[1];
            }).join("&point=");

            var url = `https://graphhopper.com/api/1/route?point=${pointsString}&snap_preventions=motorway,ferry,tunnel&details=road_class,surface&profile=car&locale=en&instructions=true&calc_points=true&points_encoded=false&key=${apiKey}`;

            // Debugging: Check the generated URL
            console.log("Route URL: ", url);

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log("GraphHopper API Response: ", data); // Log the full response

                    // Check if there are any valid routes
                    if (data.paths && data.paths.length > 0) {
                        var route = data.paths[0]; // Get the best route
                        var routeCoordinates = route.points.coordinates.map(function (coord) {
                            return [coord[1], coord[0]]; // Switch lat/lon order
                        });

                        // Create a new polyline to display the route
                        routeLayer = L.polyline(routeCoordinates, { color: 'blue', weight: 4 }).addTo(map);
                        map.fitBounds(routeLayer.getBounds());
                        document.getElementById("route-info").innerHTML = `Route between selected points is displayed.`;
                    } else {
                        console.log("No valid route data found.");
                        document.getElementById("route-info").innerHTML = `No valid route found between the points.`;
                    }
                })
                .catch(error => {
                    console.error("Error fetching route:", error);
                    document.getElementById("route-info").innerHTML = `Error fetching route.`;
                });
        }

        // Click event to select points
        map.on('click', function (e) {
            if (points.length < 4) {
                let latlng = [e.latlng.lat, e.latlng.lng];
                points.push(latlng);
                addMarker(latlng);
                document.getElementById("route-info").innerHTML = `${points.length} point(s) selected.`;
            }
        });

        // Add event listener to the button to display the route
        document.getElementById("display-route").addEventListener('click', function() {
            displayRoute();
        });
    </script>
</body>
</html>
