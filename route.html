<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 600px; }
        .info {
            margin: 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h2>Click on the map to select points</h2>
    <div id="map"></div>
    <div class="info" id="route-info"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Initialize the map
        var map = L.map('map').setView([48.118477, 11.539421], 13); // Default center at a location
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var points = []; // Array to store points clicked on the map
        var markers = []; // Array to store marker objects

        // Function to add points when clicking on the map
        function onMapClick(e) {
            if (points.length < 4) { // Limit the number of points to 4
                // Add the point to the array (latitude, longitude)
                points.push([e.latlng.lat, e.latlng.lng]);
                
                // Add marker to the map
                var marker = L.marker(e.latlng).addTo(map);
                markers.push(marker);

                // If there are two or more points, enable route calculation
                if (points.length >= 2) {
                    getRoute();
                }
            } else {
                alert("You can only select up to 4 points.");
            }
        }

        // Add the click event to the map
        map.on('click', onMapClick);

        // Function to fetch the route from GraphHopper API
        function getRoute() {
            var url = "https://graphhopper.com/api/1/route?key=e18fd573-f742-4069-8f82-5642fae3450e"; // GraphHopper API URL

            // Prepare the points array for the JSON format (GraphHopper requires [longitude, latitude])
            var pointsParam = points.map(function(point) {
                return [point[1], point[0]]; // Reverse lat/lng order for GraphHopper API (longitude, latitude)
            });

            // Construct the body payload for the API request
            var requestBody = {
                points: pointsParam,
                profile: "car",
                instructions: true
            };

            // Make the API request
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.paths && data.paths.length > 0) {
                    displayRoute(data.paths);
                } else {
                    alert("No route found.");
                }
            })
            .catch(error => {
                console.error('Error fetching route:', error);
            });
        }

        // Function to display the route on the map
        function displayRoute(paths) {
            var routeInfo = document.getElementById('route-info');
            routeInfo.innerHTML = ''; // Clear the route info

            paths.forEach((path, index) => {
                // Create a polyline for each route
                var routeCoordinates = path.points.coordinates.map(function(coord) {
                    return [coord[1], coord[0]]; // Reverse back to lat/lng for Leaflet
                });

                // Add polyline to the map
                var routePolyline = L.polyline(routeCoordinates, { color: 'blue' }).addTo(map);

                // Display route info (length and time)
                var distanceKm = (path.distance / 1000).toFixed(2); // Convert meters to kilometers
                var timeMin = (path.time / 60000).toFixed(2); // Convert milliseconds to minutes

                var routeDetails = `
                    <h3>Route ${index + 1}</h3>
                    <p><strong>Distance:</strong> ${distanceKm} km</p>
                    <p><strong>Time:</strong> ${timeMin} minutes</p>
                `;
                routeInfo.innerHTML += routeDetails;
            });

            // Adjust map bounds to fit the route
            var bounds = L.latLngBounds(paths[0].points.coordinates.map(function(coord) {
                return [coord[1], coord[0]]; // Reverse back to lat/lng
            }));
            map.fitBounds(bounds);
        }
    </script>
</body>
</html>
