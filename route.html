<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Planner</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div id="map" style="height: 500px;"></div>
    <div id="route-info" style="margin-top: 10px;"></div>

    <script>
        // Initialize map
        var map = L.map('map').setView([48.118477, 11.539421], 13); // Default starting point

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var points = []; // Array to store selected points
        var routeLayer = null; // To store the drawn route on the map

        // Function to handle map click event and store points
        map.on('click', function(e) {
            if (points.length < 2) {
                // Add marker at clicked position
                L.marker(e.latlng).addTo(map);
                points.push([e.latlng.lat, e.latlng.lng]);

                if (points.length === 2) {
                    // Once 2 points are selected, fetch the route
                    fetchRoute(points);
                }
            } else {
                // If more than 2 points are selected, reset points array
                points = [];
                map.eachLayer(function(layer) {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });
                document.getElementById("route-info").innerHTML = "Please select two points on the map.";
            }
        });

        // Function to fetch the route using GraphHopper API
        function fetchRoute(points) {
            // Construct the request body with the selected points
            var requestBody = {
                "points": points,
                "snap_preventions": [
                    "motorway",
                    "ferry",
                    "tunnel"
                ],
                "details": [
                    "road_class",
                    "surface"
                ],
                "profile": "car",
                "locale": "en",
                "instructions": true,
                "calc_points": true,
                "points_encoded": false
            };

            var url = 'https://graphhopper.com/api/1/route?key=e18fd573-f742-4069-8f82-5642fae3450e';

            // Send the POST request
            fetch(url, {
                method: 'POST', // Use POST method
                headers: {
                    'Content-Type': 'application/json' // Set content type to JSON
                },
                body: JSON.stringify(requestBody) // Send the data as JSON
            })
            .then(response => response.json())
            .then(data => {
                console.log("GraphHopper API Response:", data); // Log the full response

                if (data.paths && data.paths.length > 0) {
                    var route = data.paths[0]; // Get the first route
                    if (route.points && route.points.coordinates) {
                        var routeCoordinates = route.points.coordinates.map(function (coord) {
                            return [coord[1], coord[0]];  // Switch lat/lon order for leaflet
                        });

                        // Remove the existing route layer if any
                        if (routeLayer) {
                            map.removeLayer(routeLayer);
                        }

                        // Create a new polyline to display the route on the map
                        routeLayer = L.polyline(routeCoordinates, { color: 'blue', weight: 4 }).addTo(map);
                        map.fitBounds(routeLayer.getBounds());
                        document.getElementById("route-info").innerHTML = "Route between selected points is displayed.";
                    } else {
                        console.log("Route points or coordinates are missing in the response.");
                        document.getElementById("route-info").innerHTML = "Route data is incomplete.";
                    }
                } else {
                    console.log("No valid route found.");
                    document.getElementById("route-info").innerHTML = "No valid route found.";
                }
            })
            .catch(error => {
                console.error("Error fetching route:", error);
                document.getElementById("route-info").innerHTML = "Error fetching route.";
            });
        }
    </script>
</body>
</html>
