<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>BazyGo â€“ Ù…Ø´ØºÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø¨Ø«</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/flv.js/dist/flv.min.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:tahoma;background:#f3f4f6}

header{
    padding:6px 10px;
    background:linear-gradient(90deg,#1e3a8a,#2563eb);
    color:#fff;
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:12px
}

.tabs{display:flex;background:#fff;border-bottom:1px solid #ddd}
.tab{padding:8px 12px;cursor:pointer;font-size:12px}
.tab.active{border-bottom:3px solid #2563eb;font-weight:bold}

.container{display:flex;height:calc(100vh - 80px)}
.left{width:40%;padding:8px;overflow:auto}
.right{width:60%;padding:8px;display:flex;flex-direction:column}

.container.hide-right .right{display:none}
.container.hide-right .left{width:100%}

.card{background:#fff;border-radius:8px;padding:8px;margin-bottom:8px}

.vehicle-list{display:flex;flex-direction:column;gap:6px}
.vehicle-item{
    border:1px solid #ddd;
    border-radius:6px;
    padding:6px;
    font-size:11px;
    background:#f9fafb
}
.vehicle-row{display:flex;justify-content:space-between;align-items:center}
.vehicle-buttons{display:flex;gap:6px;margin-top:4px}
.cam-btn{
    padding:4px 8px;
    border-radius:999px;
    border:1px solid #ccc;
    font-size:10px;
    cursor:pointer
}

.cam-btn.active{background:#2563eb;color:#fff}

#videoWrapper{
    flex:1;
    background:#000;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:8px
}
video{width:100%;height:100%;background:#000}

.studio-grid{
    display:grid;
    gap:8px;
    grid-template-columns:repeat(auto-fill,minmax(220px,1fr))
}
.studio-tile{background:#000;border-radius:8px;position:relative}
.studio-tile video{width:100%;height:100%}
.studio-close{
    position:absolute;top:4px;left:4px;
    border:none;border-radius:50%;
    width:26px;height:26px;
    background:red;color:#fff;cursor:pointer
}
</style>
</head>

<body>

<header>
    <div>ğŸ¥ BazyGo Camera Player</div>
    <button id="toggleRightBtn">â¬… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø´ØºÙ„</button>
</header>

<div class="tabs">
    <div class="tab active" onclick="showTab('history')">ğŸ“ ØªØ³Ø¬ÙŠÙ„Ø§Øª</div>
    <div class="tab" onclick="showTab('live')">ğŸ“¡ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±</div>
    <div class="tab" onclick="showTab('studio')">ğŸ¬ Studio</div>
</div>

<div class="container" id="mainContainer">

<div class="left">

<div id="livePanel" class="card" style="display:none">
<h4>ğŸ“¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h4>
<div id="liveVehicleList" class="vehicle-list"></div>
</div>

<div id="studioPanel" class="card" style="display:none">
<h4>ğŸ¬ Studio</h4>
<div id="studioVehicleList" class="vehicle-list"></div>
</div>

</div>

<div class="right">
<div id="videoWrapper">
<video id="videoPlayer" muted autoplay playsinline></video>
</div>

<div id="studioGrid" class="studio-grid" style="display:none"></div>
</div>

</div>

<script>
const STREAM_HOST="streaming.bazytrack.jo";
const WEBAPP_URL="https://script.google.com/macros/s/AKfycbwwI70vwtzhZtzChTG7WzF-UvQIHm0z2iXNH70wYzB0vjgodvsT3ciHcaN0MohSmeMW/exec";

const deviceNames={"1":"Vehicle 1","2":"Vehicle 2"};
const deviceImeis={"1":"111111","2":"222222"};

let flvPlayer=null;
let lastLive=null;
const studioStreams={};

const videoPlayer=document.getElementById("videoPlayer");

document.getElementById("toggleRightBtn").onclick=()=>{
    document.getElementById("mainContainer").classList.toggle("hide-right");
};

function showTab(tab){
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelector(`.tab[onclick*=${tab}]`).classList.add("active");

    document.getElementById("livePanel").style.display=tab==="live"?"block":"none";
    document.getElementById("studioPanel").style.display=tab==="studio"?"block":"none";
    document.getElementById("videoWrapper").style.display=tab!=="studio"?"flex":"none";
    document.getElementById("studioGrid").style.display=tab==="studio"?"grid":"none";
}

function cleanPlayer(){
    if(flvPlayer){
        flvPlayer.destroy();
        flvPlayer=null;
    }
    videoPlayer.pause();
    videoPlayer.src="";
}

async function startLive(deviceId, cam){
    const imei=deviceImeis[deviceId];
    if(lastLive===imei) cleanPlayer();
    lastLive=imei;

    await fetch(`${WEBAPP_URL}?type=${cam}&deviceId=${deviceId}&imei=${imei}`).catch(()=>{});

    const url=`https://${STREAM_HOST}/live/0/${imei}.flv`;
    flvPlayer=flvjs.createPlayer({type:"flv",url,isLive:true});
    flvPlayer.attachMediaElement(videoPlayer);
    flvPlayer.load();
    flvPlayer.play();
}

function renderLiveList(){
    const list=document.getElementById("liveVehicleList");
    list.innerHTML="";
    Object.keys(deviceNames).forEach(id=>{
        list.innerHTML+=`
        <div class="vehicle-item">
            <div class="vehicle-row"><b>${deviceNames[id]}</b></div>
            <div class="vehicle-buttons">
                <button class="cam-btn" onclick="startLive('${id}','livein')">IN</button>
                <button class="cam-btn" onclick="startLive('${id}','liveout')">OUT</button>
            </div>
        </div>`;
    });
}

function addStudio(deviceId,cam){
    if(studioStreams[deviceId]){
        studioStreams[deviceId].remove();
        delete studioStreams[deviceId];
    }
    const imei=deviceImeis[deviceId];
    fetch(`${WEBAPP_URL}?type=${cam}&deviceId=${deviceId}&imei=${imei}`).catch(()=>{});

    const tile=document.createElement("div");
    tile.className="studio-tile";
    const v=document.createElement("video");
    v.autoplay=true;v.muted=true;
    tile.appendChild(v);

    const close=document.createElement("button");
    close.className="studio-close";
    close.innerText="âœ•";
    close.onclick=()=>{tile.remove();delete studioStreams[deviceId];};
    tile.appendChild(close);

    document.getElementById("studioGrid").appendChild(tile);

    const url=`https://${STREAM_HOST}/live/0/${imei}.flv`;
    const p=flvjs.createPlayer({type:"flv",url,isLive:true});
    p.attachMediaElement(v);p.load();p.play();

    studioStreams[deviceId]=tile;
}

function renderStudioList(){
    const list=document.getElementById("studioVehicleList");
    list.innerHTML="";
    Object.keys(deviceNames).forEach(id=>{
        list.innerHTML+=`
        <div class="vehicle-item">
            <b>${deviceNames[id]}</b>
            <div class="vehicle-buttons">
                <button class="cam-btn" onclick="addStudio('${id}','livein')">IN</button>
                <button class="cam-btn" onclick="addStudio('${id}','liveout')">OUT</button>
            </div>
        </div>`;
    });
}

renderLiveList();
renderStudioList();
</script>

</body>
</html>
