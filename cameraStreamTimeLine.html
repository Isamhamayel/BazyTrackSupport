<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>BazyGo â€“ Ù…Ø´ØºÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø¨Ø«</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- FLV.js -->
<script src="https://cdn.jsdelivr.net/npm/flv.js/dist/flv.min.js"></script>

<style>
* { box-sizing:border-box; }
body { margin:0; font-family:'Tahoma', Arial, sans-serif; background:#f3f4f6; color:#111827; }

header {
    padding:4px 10px;
    background:linear-gradient(90deg,#1e3a8a,#2563eb);
    font-size:12px;
    font-weight:bold;
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:space-between;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}
header .sub {
    font-size:11px;
    font-weight:normal;
    opacity:.85;
}

.tabs {
    display:flex;
    background:#fff;
    border-bottom:1px solid #e5e7eb;
}
.tab {
    padding:8px 12px;
    cursor:pointer;
    font-size:13px;
    border-bottom:3px solid transparent;
    color:#6b7280;
    display:flex;
    align-items:center;
    gap:6px;
}
.tab.active {
    border-color:#2563eb;
    color:#1d4ed8;
    font-weight:bold;
    background:#eff6ff;
}

.container {
    display:flex;
    height:calc(100vh - 60px);
}

/* LEFT PANEL */
.left {
    width:30%;
    min-width:280px; /* Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„ÙƒÙ† Ø£Ù†ØµØ­ Ø¨Ù‡ */
    background:#f9fafb;
    border-left:1px solid #e5e7eb;
    padding:8px;
    display:flex;
    flex-direction:column;
    gap:8px;
}


.card {
    background:#fff;
    border-radius:8px;
    box-shadow:0 1px 2px rgba(0,0,0,0.04);
    padding:8px;
    border:1px solid #e5e7eb;
}

.card-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:6px;
}
.card-header h3 {
    margin:0;
    font-size:12px;
    font-weight:bold;
}
.card-header small {
    font-size:10px;
    color:#6b7280;
}

.filters {
    display:flex;
    flex-wrap:wrap;
    gap:4px;
    margin-bottom:6px;
}

.filters select,
.filters input[type=date] {
    padding:4px 6px;
    border-radius:6px;
    border:1px solid #d1d5db;
    font-size:11px;
    background:#f9fafb;
    min-width:90px;
}

.cam-buttons {
    display:flex;
    flex-wrap:wrap;
    gap:4px;
    margin-bottom:6px;
}
.cam-btn {
    padding:4px 8px;
    border-radius:999px;
    border:1px solid #d1d5db;
    cursor:pointer;
    background:#f9fafb;
    font-size:10px;
    display:inline-flex;
    align-items:center;
    gap:4px;
}
.cam-btn.active {
    background:#2563eb;
    color:#fff;
    border-color:#2563eb;
}

.file-list {
    max-height:50vh;
    overflow-y:auto;
    margin-top:4px;
}

.file-item {
    background:#f9fafb;
    padding:7px 8px;
    margin-bottom:5px;
    border-radius:6px;
    border:1px solid #e5e7eb;
    cursor:pointer;
    transition:.15s;
    font-size:11px;
}
.file-item:hover {
    background:#eff6ff;
    border-color:#2563eb;
}
.time-label {
    font-size:10px;
    color:#6b7280;
    margin-bottom:1px;
}

.info-text {
    font-size:10px;
    color:#6b7280;
}

/* RIGHT PANEL */
right {
    width:70%;
    padding:8px;
    background:#f3f4f6;
    display:flex;
    flex-direction:column;
    gap:6px;
    height:100%;          /* ğŸŸ¢ Ù…Ù‡Ù… */
}

#statusBar {
    font-size:10px;
    color:#374151;
    background:#e5e7eb;
    border-radius:999px;
    padding:4px 8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

#statusText {
    display:flex;
    align-items:center;
    gap:4px;
}

.badge {
    padding:2px 6px;
    border-radius:999px;
    font-size:9px;
    background:#d1fae5;
    color:#047857;
}

.controls-row {
    display:flex;
    gap:4px;
    flex-wrap:wrap;
}

.btn {
    border:none;
    border-radius:999px;
    padding:5px 8px;
    font-size:10px;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:4px;
    background:#111827;
    color:#fff;
}
.btn.secondary {
    background:#e5e7eb;
    color:#111827;
}
.btn:disabled {
    opacity:.5;
    cursor:default;
}

#errorMessage {
    display:none;
    padding:5px 7px;
    background:#fef2f2;
    color:#b91c1c;
    border:1px solid:#fecaca;
    border-radius:6px;
    font-size:10px;
}

/* VIDEO WRAPPER */
#videoWrapper {
    position:relative;
    flex:1 1 auto;        /* ğŸŸ¢ Ù…Ù‡Ù… */
    min-height:0;         /* ğŸŸ¢ Ù…Ù‡Ù… */
    display:flex;
    align-items:center;
    justify-content:center;
    background:#000;
    border-radius:10px;
    overflow:hidden;
}
#videoPlayer {
    width:100%;
    height:100%;
    max-height:100%;
    border-radius:10px;
    background:#000;
}

/* LOADING OVERLAY */
#loadingOverlay {
    position:absolute;
    inset:0;
    background:rgba(17,24,39,0.8);
    display:none;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    color:#e5e7eb;
    font-size:11px;
}
.spinner {
    width:24px; height:24px;
    border:3px solid rgba(209,213,219,0.6);
    border-top:3px solid #3b82f6;
    border-radius:50%;
    animation:spin .7s linear infinite;
    margin-bottom:6px;
}
@keyframes spin { 100% { transform:rotate(360deg); } }
#loadingCountdown {
    font-size:10px;
    margin-top:2px;
    color:#9ca3af;
}

/* MOBILE */
@media(max-width:900px){
    .container { flex-direction:column; height:auto; }
    .left { width:100%; }
    .right { width:100%; }
    .file-list { max-height:30vh; }
}
</style>
</head>

<body>

<header>
    <div>ğŸ¥ Ù…Ø´ØºÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø¨Ø« â€“ BazyGo</div>
    <div class="sub">FLV Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Â· LL-HLS Ù„Ù„Ø¢ÙŠÙÙˆÙ† Â· Ø¨Ø¯ÙˆÙ† ØµÙˆØª</div>
</header>

<div class="tabs">
    <span id="tabHistory" class="tab active" onclick="showTab('history')">ğŸ“ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª</span>
    <span id="tabLive" class="tab" onclick="showTab('live')">ğŸ“¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</span>
</div>

<div class="container">

    <!-- LEFT SIDE -->
    <div class="left">

        <!-- HISTORY PANEL -->
        <div id="historyPanel" class="card">
            <div class="card-header">
                <h3>Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„ÙˆÙ‚Øª</h3>
                <small>Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ ÙˆØ§Ù„Ø³Ø§Ø¹Ø©</small>
            </div>

            <div class="filters">
                <select id="deviceSelect" onchange="loadFiles()">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø²</option>
                </select>
                <input type="date" id="datePicker" onchange="loadFiles()">
                <select id="hourPicker" onchange="loadFiles()">
                    <option value="">Ø§Ù„Ø³Ø§Ø¹Ø©</option>
                </select>
            </div>

            <div class="cam-buttons">
                <button id="btnC1" class="cam-btn active" onclick="setCam(1)">ğŸ¦ ÙƒØ§Ù…ÙŠØ±Ø§ 1</button>
                <button id="btnC2" class="cam-btn" onclick="setCam(2)">ğŸ¦ ÙƒØ§Ù…ÙŠØ±Ø§ 2</button>
                <button id="btnCAll" class="cam-btn" onclick="setCam('all')">ğŸ” ÙƒÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª</button>
            </div>

            <div id="fileList" class="file-list">
                <div class="info-text">Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù‡Ø§Ø² ÙˆØªØ§Ø±ÙŠØ® ÙˆØ³Ø§Ø¹Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø©.</div>
            </div>
        </div>

        <!-- LIVE PANEL -->
        <div id="livePanel" class="card" style="display:none;">
            <div class="card-header">
                <h3>Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
                <small>Ø§Ø®ØªØ± Ø¬Ù‡Ø§Ø²Ø§Ù‹ Ø«Ù… Ù†ÙˆØ¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</small>
            </div>

            <div class="filters">
                <select id="liveDeviceSelect">
                    <option value="">Ø§Ø®ØªØ± Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¨Ø«</option>
                </select>
            </div>

            <div class="cam-buttons">
                <button class="cam-btn" onclick="startLive('livein')">ğŸ“¡ ÙƒØ§Ù…ÙŠØ±Ø§ Ø¯Ø§Ø®Ù„ÙŠØ© (livein)</button>
                <button class="cam-btn" onclick="startLive('liveout')">ğŸ“¡ ÙƒØ§Ù…ÙŠØ±Ø§ Ø®Ø§Ø±Ø¬ÙŠØ© (liveout)</button>
            </div>

            <div class="info-text">
                Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø¨Ø« (Ø­ØªÙ‰ Ù¥ Ù…Ø­Ø§ÙˆÙ„Ø§Øª).
            </div>
        </div>

    </div>

    <!-- RIGHT SIDE -->
    <div class="right">

        <div id="statusBar">
            <div id="statusText">
                <span>Ø§Ù„Ø­Ø§Ù„Ø©:</span>
                <span id="statusValue">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</span>
            </div>
            <div>
                <span class="badge" id="modeBadge">ØªØ³Ø¬ÙŠÙ„Ø§Øª</span>
            </div>
        </div>

        <div class="controls-row">
            <button id="downloadBtn" class="btn secondary" type="button" onclick="openExternalDownload()" style="display:none;">
                â¬‡ ÙØªØ­ FLV ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
            </button>
        </div>

        <div id="errorMessage"></div>

        <div id="videoWrapper">
            <video id="videoPlayer"
                   controls
                   playsinline
                   webkit-playsinline
                   muted
                   onclick="manualPlayInIOS()"></video>

            <div id="loadingOverlay">
                <div class="spinner"></div>
                <div id="loadingText">Ø¬Ø§Ø±Ù ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...</div>
                <div id="loadingCountdown"></div>
            </div>
        </div>

        <div class="info-text">
            âš ï¸ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø¯ÙˆÙ† ØµÙˆØª Ø¯Ø§Ø¦Ù…Ø§Ù‹. Ø¹Ù„Ù‰ Ø£Ø¬Ù‡Ø²Ø© iPhone Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„.
        </div>

        <!-- TIMELINE SLIDER -->
        <div style="margin-top:10px; padding:5px; background:#fff; border-radius:8px; border:1px solid #e5e7eb;">
            <input id="timelineSlider"
                   type="range"
                   min="0"
                   max="0"
                   value="0"
                   step="1"
                   style="width:100%;"
                   oninput="timelineDragging()"
                   onchange="timelineDropped()">
            <div id="timelineLabel"
                 style="font-size:12px; color:#555; text-align:center; margin-top:3px;">
                Ø§Ø³Ø­Ø¨ Ù„Ø§Ø®ØªÙŠØ§Ø± ÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…
            </div>

           
        </div>

        <div class="info-text">
            Ø´Ø±ÙŠØ· Ø§Ù„ÙˆÙ‚Øª Ø£Ø¹Ù„Ø§Ù‡ ÙŠØºØ·ÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø­Ø¯Ø¯ØŒ ÙˆÙŠÙ…ÙƒÙ†Ù‡ ØªØ´ØºÙŠÙ„ Ù¥ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù…ØªØªØ§Ù„ÙŠØ© ÙƒÙ‚Ø§Ø¦Ù…Ø© ØªØ´ØºÙŠÙ„.
        </div>
    </div>

</div>

<script>
/* ===================== CONFIG ===================== */
const FILE_SHEET_ID   = "1GjVH6jlTGf7BEBqld0GEX1yMqUgfQc235g64CWdNyUM";
const DEVICE_SHEET_ID = FILE_SHEET_ID;

const FILE_SHEET_URL =
  `https://docs.google.com/spreadsheets/d/${FILE_SHEET_ID}/gviz/tq?tqx=out:json`;
const DEVICE_SHEET_URL =
  `https://docs.google.com/spreadsheets/d/${DEVICE_SHEET_ID}/gviz/tq?tqx=out:json&sheet=Devices`;

const WEBAPP_URL =
  "https://script.google.com/macros/s/AKfycbwwI70vwtzhZtzChTG7WzF-UvQIHm0z2iXNH70wYzB0vjgodvsT3ciHcaN0MohSmeMW/exec";

const STREAM_HOST = "streaming.bazytrack.jo";

/* ===================== STATE ===================== */
const ua = navigator.userAgent;
const isIOS    = /iPad|iPhone|iPod/.test(ua);
const isSafari = /^((?!chrome|android).)*safari/i.test(ua);

let cameraFilter = 1;
let flvPlayer = null;

let deviceNames = {};
let deviceImeis = {};

let currentDownloadUrl = "";
let lastStream = null;
let liveReconnectAttempts = 0;
const MAX_LIVE_RECONNECTS = 5;
let reconnectTimeoutId = null;

// Files for timeline
let allFilesForDate = [];
let lastDeviceIdForDate = null;
let lastDateForDate = null;

/* ===================== DOM SHORTCUTS ===================== */
const videoPlayer      = document.getElementById("videoPlayer");
const loadingOverlay   = document.getElementById("loadingOverlay");
const loadingText      = document.getElementById("loadingText");
const loadingCountdown = document.getElementById("loadingCountdown");
const errorMessage     = document.getElementById("errorMessage");
const statusValue      = document.getElementById("statusValue");
const modeBadge        = document.getElementById("modeBadge");
const downloadBtn      = document.getElementById("downloadBtn");

const tabHistory       = document.getElementById("tabHistory");
const tabLive          = document.getElementById("tabLive");
const historyPanel     = document.getElementById("historyPanel");
const livePanel        = document.getElementById("livePanel");

const deviceSelect     = document.getElementById("deviceSelect");
const liveDeviceSelect = document.getElementById("liveDeviceSelect");
const datePicker       = document.getElementById("datePicker");
const hourPicker       = document.getElementById("hourPicker");
const fileList         = document.getElementById("fileList");
const btnC1            = document.getElementById("btnC1");
const btnC2            = document.getElementById("btnC2");
const btnCAll          = document.getElementById("btnCAll");

const timelineSlider   = document.getElementById("timelineSlider");
const timelineLabel    = document.getElementById("timelineLabel");


/* ===================== UI HELPERS ===================== */
function showTab(tab){
    tabHistory.classList.toggle("active", tab === "history");
    tabLive.classList.toggle("active", tab === "live");
    historyPanel.style.display = (tab === "history") ? "block" : "none";
    livePanel.style.display    = (tab === "live")    ? "block" : "none";
    if (tab === "history"){
        modeBadge.textContent = "ØªØ³Ø¬ÙŠÙ„Ø§Øª";
        modeBadge.style.background = "#e0f2fe";
        modeBadge.style.color = "#1d4ed8";
    } else {
        modeBadge.textContent = "Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±";
        modeBadge.style.background = "#dcfce7";
        modeBadge.style.color = "#166534";
    }
}

function setStatus(text){
    statusValue.textContent = text;
}

function showLoading(flag, text){
    loadingOverlay.style.display = flag ? "flex" : "none";
    if (text) loadingText.textContent = text;
    if (!flag) loadingCountdown.textContent = "";
}

function showError(msg){
    if (!msg){
        errorMessage.style.display = "none";
        errorMessage.textContent = "";
    } else {
        errorMessage.style.display = "block";
        errorMessage.textContent = msg;
    }
}

/* ÙØªØ­ FLV Ø®Ø§Ø±Ø¬ Traccar Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© */
function openExternalDownload() {
    if (!currentDownloadUrl) return;
    const url = currentDownloadUrl;
    const isAndroid = /Android/i.test(ua);
    const isiOS     = /iPhone|iPad|iPod/i.test(ua);

    if (isAndroid){
        window.location.href = "googlechrome://navigate?url=" + url;
        setTimeout(() => { window.location.href = url; }, 800);
        return;
    }
    if (isiOS){
        window.location.href = url;
        return;
    }
    window.open(url, "_blank");
}

function manualPlayInIOS(){
    if (!isIOS) return;
    videoPlayer.play().catch(()=>{});
}

/* ===================== CLEAN VIDEO PLAYER ===================== */
function cleanPlayer() {
    if (flvPlayer) {
        try {
            flvPlayer.pause();
            flvPlayer.unload();
            flvPlayer.detachMediaElement();
            flvPlayer.destroy();
        } catch (e) {
            console.warn("FLV cleanup error:", e);
        }
        flvPlayer = null;
    }

    if (reconnectTimeoutId) {
        clearTimeout(reconnectTimeoutId);
        reconnectTimeoutId = null;
    }

    try { videoPlayer.pause(); } catch(e){}
    videoPlayer.removeAttribute("src");
    videoPlayer.srcObject = null;
    videoPlayer.load();

    videoPlayer.muted = true;
    videoPlayer.volume = 0;
}

/* ===================== HLS â€” SAFARI / iOS ===================== */
async function waitForHlsReady(url, timeoutMs = 20000) {
    const start = Date.now();

    while (Date.now() - start < timeoutMs) {
        try {
            const r = await fetch(url, { cache: "no-store" });
            if (r.status === 200 || r.status === 206) return true;
        } catch(e){}

        await new Promise(res => setTimeout(res, 1000));
    }
    return false;
}

/* ===================== FLV â€” RETRY SYSTEM ===================== */
async function playFLV(url, maxAttempts = 20) {
    return new Promise((resolve, reject) => {
        let attempt = 0;
        let stopped = false;   // ğŸŸ¢ flag to stop retries

        async function tryPlay() {
            if (stopped) return;  // ğŸ›‘ do NOT retry after success

            attempt++;
            console.log("FLV attempt:", attempt);

            // Cleanup previous player
            if (flvPlayer) {
                try {
                    flvPlayer.pause();
                    flvPlayer.unload();
                    flvPlayer.detachMediaElement();
                    flvPlayer.destroy();
                } catch(e){}
            }

            try {
                flvPlayer = flvjs.createPlayer({ type: "flv", url });
                flvPlayer.attachMediaElement(videoPlayer);
                flvPlayer.load();

                videoPlayer.play().then(() => {
                    console.log("FLV PLAY SUCCESS ğŸ‰");
                    stopped = true;     // ğŸ›‘ stop retrying
                    resolve(true);
                }).catch(() => {});
            } catch(e){}

            // Retry ONLY if not stopped
            if (!stopped) {
                if (attempt < maxAttempts) {
                    setTimeout(tryPlay, 1250);
                } else {
                    reject(false);
                }
            }
        }

        tryPlay();
    });
}


/* ===================== UNIFIED PLAY FUNCTION (HISTORY + LIVE) ===================== */
async function playWithWait(imei, mode, meta = {}) {
    const isHls = isIOS || isSafari;
    const flvUrl = `https://${STREAM_HOST}/live/0/${imei}.flv`;
    const hlsUrl = `https://${STREAM_HOST}/live/0/${imei}.m3u8`;
    const url = isHls ? hlsUrl : flvUrl;

    lastStream = { imei, mode, isHls, meta };
    currentDownloadUrl = flvUrl; // Ø²Ø± "ÙØªØ­ FLV ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­"
    downloadBtn.style.display = "inline-flex";
    cleanPlayer();
    showError("");
    showLoading(true, mode === "live" ? "Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø«..." : "Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„...");
    setStatus("Ø§Ù†ØªØ¸Ø§Ø± Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø¨Ø«...");

    /* ------- HLS MODE ------- */
    if (isHls) {
        const ready = await waitForHlsReady(url, 25000);

        if (!ready) {
            showLoading(false);
            showError("Ø§Ù„Ø¨Ø« ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ø­Ø§Ù„ÙŠØ§Ù‹. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹.");
            setStatus("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ HLS");
            return;
        }

        cleanPlayer();
        videoPlayer.src = url;
        videoPlayer.load();

        videoPlayer.play()
            .then(() => {
                showLoading(false);
                setStatus(mode === "live" ? "Ø§Ù„Ø¨Ø« ÙŠØ¹Ù…Ù„" : "Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙŠØ¹Ù…Ù„");
            })
            .catch(() => {
                showLoading(false);
                showError("Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ´ØºÙŠÙ„. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠØ¯ÙˆÙŠØ§Ù‹ (iOS).");
                setStatus("Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨");
            });

        return;
    }

    /* ------- FLV MODE ------- */
    try {
        await playFLV(flvUrl, 25);

        showLoading(false);
        showError("");
        setStatus(mode === "live" ? "Ø§Ù„Ø¨Ø« ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†" : "Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†");
    } catch (e) {
        showLoading(false);
        showError("âš  ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª.");
        setStatus("ÙØ´Ù„ FLV");
    }
}

/* ===================== AUTO-RECONNECT FOR LIVE ===================== */
function tryReconnect() {
    if (!lastStream || lastStream.mode !== "live") return;

    if (liveReconnectAttempts >= MAX_LIVE_RECONNECTS) {
        showError("Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø¨Ø« Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª.");
        setStatus("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„");
        return;
    }

    liveReconnectAttempts++;
    setStatus(`Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„... (${liveReconnectAttempts}/${MAX_LIVE_RECONNECTS})`);
    showLoading(true, "Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§ØªØµØ§Ù„...");

    reconnectTimeoutId = setTimeout(() => {
        playWithWait(lastStream.imei, "live", lastStream.meta);
    }, 3000);
}

videoPlayer.addEventListener("error", tryReconnect);
videoPlayer.addEventListener("stalled", tryReconnect);

// Ø¥Ø¬Ø¨Ø§Ø± ÙƒØªÙ… Ø§Ù„ØµÙˆØª Ø¯Ø§Ø¦Ù…Ø§Ù‹
videoPlayer.addEventListener("volumechange", () => {
    if (!videoPlayer.muted || videoPlayer.volume !== 0){
        videoPlayer.muted = true;
        videoPlayer.volume = 0;
    }
});

/* ===================== PLAYBACK CONTROLS (HISTORY & LIVE) ===================== */
async function playVideo(filename, deviceId){
    const imei = deviceImeis[deviceId];
    if (!imei){
        showError("Ù„Ø§ ÙŠÙˆØ¬Ø¯ IMEI Ù…Ø¹Ø±Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙŠ Ø¬Ø¯ÙˆÙ„ Devices.");
        return;
    }

    setStatus(`Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (${filename}) Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²...`);
    showLoading(true, "Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²...");
    showError("");

    try {
        await fetch(`${WEBAPP_URL}?type=playback&deviceId=${deviceId}&fileName=${encodeURIComponent(filename)}&imei=${imei}`)
            .catch(()=>{});
    } catch(e){}

    setTimeout(() => {
        playWithWait(imei, "history", { filename, deviceId });
    }, 10000);
}

async function startLive(kind){
    const deviceId = liveDeviceSelect.value;
    if (!deviceId || !deviceImeis[deviceId]){
        showError("Ø§Ø®ØªØ± Ø¬Ù‡Ø§Ø²Ø§Ù‹ Ù…Ø²ÙˆØ¯Ø§Ù‹ Ø¨ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±.");
        return;
    }

    const imei = deviceImeis[deviceId];
    showError("");
    setStatus(`Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± ${kind} Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²...`);
    showLoading(true, "Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²...");

    try {
        await fetch(`${WEBAPP_URL}?type=${kind}&deviceId=${deviceId}&imei=${imei}`)
            .catch(()=>{});
    } catch(e){}

    // Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ù…Ø± Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø³ØªØ±ÙŠÙ…
    playWithWait(imei, "live", { kind, deviceId });
}

/* ===================== CAMERA FILTER ===================== */
function setCam(c){
    cameraFilter = c;
    btnC1.classList.toggle("active", c===1);
    btnC2.classList.toggle("active", c===2);
    btnCAll.classList.toggle("active", c==="all");

    lastDeviceIdForDate = null;
    allFilesForDate = [];
    loadFiles();
}

/* ===================== LOAD DEVICE NAMES/DROPDOWN ===================== */
async function loadDeviceNames() {
    const query = "select A,B,C";
    const url = DEVICE_SHEET_URL + "&tq=" + encodeURIComponent(query);

    try {
        const res = await fetch(url);
        const txt = await res.text();
        const json = JSON.parse(txt.substring(47).slice(0,-2));
        const rows = json.table.rows || [];

        rows.forEach(r => {
            const deviceId = r.c[0]?.v;
            const imei     = r.c[1]?.v;
            const name     = r.c[2]?.v;

            if (!deviceId) return;

            deviceNames[deviceId] = name || ("Ø¬Ù‡Ø§Ø² " + deviceId);
            deviceImeis[deviceId] = imei;
        });
    } catch(err) {
        console.error("Error loading device names:", err);
    }
}

async function loadDeviceDropdown() {
    await loadDeviceNames();

    const params = new URLSearchParams(window.location.search);
    const decoded = params.get("params")
        ? JSON.parse(decodeURIComponent(params.get("params")))
        : {};

    const ids = (decoded["ds16.devices"] || "")
                    .split(",")
                    .map(x => x.trim())
                    .filter(Boolean);

    deviceSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø²</option>';
    liveDeviceSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¨Ø«</option>';

    ids.forEach(id => {
        if (!deviceNames[id]) return;
        const name = deviceNames[id];

        deviceSelect.innerHTML += `<option value="${id}">${name}</option>`;
        liveDeviceSelect.innerHTML += `<option value="${id}">${name}</option>`;
    });

    if (!ids.length){
        deviceSelect.innerHTML = '<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¬Ù‡Ø²Ø© Ù…Ø¹Ø±ÙØ©</option>';
        liveDeviceSelect.innerHTML = '<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¬Ù‡Ø²Ø© Ù…Ø¹Ø±ÙØ©</option>';
    }
}

/* ===================== TIMELINE + FILE LIST ===================== */
function updateTimelineFiles(list){
    allFilesForDate = list || [];
    if (!timelineSlider || !timelineLabel) return;

    if (!allFilesForDate.length){
        timelineSlider.min = 0;
        timelineSlider.max = 0;
        timelineSlider.value = 0;
        timelineLabel.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….";
        return;
    }

    timelineSlider.min = 0;
    timelineSlider.max = allFilesForDate.length - 1;
    timelineSlider.value = 0;

    const f0 = allFilesForDate[0];
    timelineLabel.textContent = `(${f0.filename}) - (${f0.time})`;
}

function timelineDragging(){
    const idx = parseInt(timelineSlider.value, 10);
    updateTimelineLabelForIndex(idx);
}

function updateTimelineLabelForIndex(idx){
    if (!allFilesForDate.length || !allFilesForDate[idx]){
        timelineLabel.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¶Ø¹.";
        return;
    }
    const f = allFilesForDate[idx];
    timelineLabel.textContent = `(${f.filename}) - (${f.time})`;
}

// Ø§Ø®ØªÙŠØ§Ø± Ù†Ù‚Ø·Ø© Ø¹Ù„Ù‰ Ø´Ø±ÙŠØ· Ø§Ù„ÙˆÙ‚Øª ÙˆØªØ´ØºÙŠÙ„ Ù¥ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù…ØªØªØ§Ù„ÙŠØ© (Ø³ÙŠØ±ÙØ± ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„Ù€ playlist)
async function timelineDropped() {
    const idx = parseInt(timelineSlider.value, 10);
    if (!allFilesForDate.length || !allFilesForDate[idx]) return;

    const selected = allFilesForDate[idx];

    hourPicker.value = selected.hour;
    renderFileListForHour();

    const files = allFilesForDate.slice(idx, idx + 5).map(f => f.filename);
    const fileListString = files.join(",");

    const imei = deviceImeis[selected.deviceId];

    try {
        await fetch(`${WEBAPP_URL}?type=playback&deviceId=${selected.deviceId}&fileName=${encodeURIComponent(fileListString)}&imei=${imei}`);
    } catch (e) {}

    playWithWait(imei, "history", { files });
}

function renderFileListForHour(){
    const hour = hourPicker.value;

    if (!allFilesForDate.length){
        fileList.innerHTML = '<div class="info-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….</div>';
        return;
    }

    let subset = allFilesForDate;
    if (hour){
        subset = allFilesForDate.filter(v => v.hour === hour);
    }

    if (!subset.length){
        fileList.innerHTML = '<div class="info-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ø§Ø¹Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².</div>';
        return;
    }

    fileList.innerHTML = "";
    subset.forEach(v => {
        if (!v.filename) return;
        fileList.innerHTML += `
            <div class="file-item" onclick="playVideo('${v.filename}','${v.deviceId}')">
                <div class="time-label">${v.filename}</div>
                <b>${v.time}</b>
            </div>
        `;
    });
}

/* ===================== LOAD FULL-DAY FILES FROM GOOGLE SHEET ===================== */
async function loadFiles(){
    const id   = deviceSelect.value;
    const date = datePicker.value;

    if (!id || !date){
        fileList.innerHTML = '<div class="info-text">Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª.</div>';
        allFilesForDate = [];
        updateTimelineFiles([]);
        return;
    }

    if (lastDeviceIdForDate === id && lastDateForDate === date && allFilesForDate.length){
        renderFileListForHour();
        updateTimelineFiles(allFilesForDate);
        return;
    }

    fileList.innerHTML = '<div class="info-text">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù„Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„...</div>';

    const sql = `select * where G=${id} order by A`;
    const url = FILE_SHEET_URL + "&tq=" + encodeURIComponent(sql);

    try {
        const text = await (await fetch(url)).text();
        const json = JSON.parse(text.substring(47).slice(0,-2));
        const rows = json.table.rows || [];

        const list = [];

        rows.forEach(r => {
            const c = r.c;
            if (!c) return;

            const raw = c[0]?.f || c[0]?.v;
            if (!raw) return;

            const parts = raw.split(" ");
            if (parts.length < 2) return;

            const mdy = parts[0];
            const t   = parts[1];
            const [M,D,Y]  = mdy.split("/");

            const d2 = `${Y}-${M.padStart(2,"0")}-${D.padStart(2,"0")}`;
            if (d2 !== date) return;

            const hh = t.split(":")[0].padStart(2,"0");

            const camVal = c[4]?.v;
            if (cameraFilter !== "all" && String(camVal) !== String(cameraFilter)) return;

            list.push({
                time: t,
                filename: c[2]?.v,
                deviceId: c[6]?.v,
                hour: hh
            });
        });

        allFilesForDate = list;
        lastDeviceIdForDate = id;
        lastDateForDate = date;

        if (!list.length){
            fileList.innerHTML = '<div class="info-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².</div>';
            updateTimelineFiles([]);
            return;
        }

        renderFileListForHour();
        updateTimelineFiles(list);

    } catch(err){
        console.error(err);
        fileList.innerHTML = '<div class="info-text">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>';
        updateTimelineFiles([]);
    }
}

/* ===================== INIT ===================== */
(function setDefaultDate(){
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm   = String(today.getMonth()+1).padStart(2,"0");
    const dd   = String(today.getDate()).padStart(2,"0");
    datePicker.value = `${yyyy}-${mm}-${dd}`;
})();

for (let h=0; h<24; h++){
    const hh = h.toString().padStart(2,"0");
    hourPicker.innerHTML += `<option value="${hh}">${hh}:00</option>`;
}

showTab('history');
loadDeviceDropdown();
setStatus("Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…. Ø§Ø®ØªØ± Ø¬Ù‡Ø§Ø²Ø§Ù‹ Ø«Ù… ØªØ³Ø¬ÙŠÙ„ Ø£Ùˆ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±.");
</script>


</body>
</html>
