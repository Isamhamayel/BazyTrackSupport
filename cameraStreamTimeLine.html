<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>BazyTrack â€“ Playback</title>

    <style>
        body { font-family: Tahoma; margin:0; background:#f4f4f4; }
        .header { background:#1f2937; color:white; padding:12px; text-align:center; }
        .controls { background:white; padding:12px; display:flex; gap:10px; flex-wrap:wrap; }
        video { width:96%; margin:15px auto; display:block; background:black; max-height:400px; }
        #timelineContainer { width:96%; margin:10px auto; background:white; padding:10px; border-radius:6px; border:1px solid #ccc; }
        #fileList { width:96%; margin:15px auto; background:white; padding:10px; border-radius:6px; border:1px solid #ccc; }
        #timelineLabel { text-align:center; margin-top:6px; font-weight:bold; color:#1e3a8a; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/flv.js@latest/dist/flv.min.js"></script>
</head>

<body>

<div class="header">
    <h2>BazyTrack â€“ Smart Playback</h2>
    <span id="statusText">Ø¬Ø§Ù‡Ø²</span>
</div>

<div class="controls">
    <label>Ø§Ù„Ø¬Ù‡Ø§Ø²:</label>
    <select id="deviceSelect"></select>

    <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
    <input type="date" id="datePicker">

    <label>Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:</label>
    <select id="cameraFilter">
        <option value="all">Ø§Ù„ÙƒÙ„</option>
        <option value="1">ÙƒØ§Ù…ÙŠØ±Ø§ 1</option>
        <option value="2">ÙƒØ§Ù…ÙŠØ±Ø§ 2</option>
    </select>

    <button onclick="loadFiles()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª</button>
</div>

<video id="videoPlayer" controls playsinline webkit-playsinline></video>

<div id="timelineContainer">
    <input type="range" id="timeline" min="0" max="100" value="0" />
    <div id="timelineLabel"></div>
</div>

<div id="fileList"></div>

<script>
/* ------------------------------------------------------
   CONFIG
------------------------------------------------------ */
const STREAM_HOST = "streaming.bazytrack.jo";
const FILE_SHEET_ID = "1GjVH6jlTGf7BEBqld0GEX1yMqUgfQc235g64CWdNyUM";
const FILE_SHEET_URL =
 `https://docs.google.com/spreadsheets/d/${FILE_SHEET_ID}/gviz/tq?tqx=out:json`;
const WEBAPP_URL =
 "https://script.google.com/macros/s/AKfycbwwI70vwtzhZtzChTG7WzF-UvQIHm0z2iXNH70wYzB0vjgodvsT3ciHcaN0MohSmeMW/exec";

let allFiles = [];
let flvPlayer = null;

/* ------------------------------------------------------
   STATUS UI
------------------------------------------------------ */
function setStatus(t){ document.getElementById("statusText").innerText = t; }

/* ------------------------------------------------------
   RESET PLAYER
------------------------------------------------------ */
function resetPlayback(){
    try {
        if (flvPlayer){
            flvPlayer.pause();
            flvPlayer.unload();
            flvPlayer.destroy();
        }
    } catch(e){}
    flvPlayer = null;

    const v = document.getElementById("videoPlayer");
    v.pause();
    v.removeAttribute("src");
    v.src = "";
    v.load();

    return new Promise(res => setTimeout(res, 200));
}

/* ------------------------------------------------------
   RETRY PLAY (LIVE-STYLE)
------------------------------------------------------ */
function retryPlay(url, isReplay){
    const v = document.getElementById("videoPlayer");
    const isIOS = /iPad|iPhone|Macintosh/.test(navigator.userAgent) && navigator.maxTouchPoints > 0;
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    // ðŸ”µ Ø§Ø®ØªÙŠØ§Ø±Ùƒ ÙƒØ§Ù† (B): HLS Ù„Ù„Ø¢ÙŠÙÙˆÙ† / FLV Ù„Ù„Ø¨Ø§Ù‚ÙŠ
    if (isIOS || isSafari){
        v.src = url.replace(".flv",".m3u8");
        v.play().catch(()=>{});
        return;
    }

    if (flvjs.isSupported()){
        flvPlayer = flvjs.createPlayer({
            type:"flv",
            url:url,
            isLive:false,
            enableStashBuffer:false
        });

        flvPlayer.attachMediaElement(v);
        flvPlayer.load();

        flvPlayer.on(flvjs.Events.METADATA_ARRIVED, ()=>{
            v.play().catch(()=>{});
        });

        flvPlayer.on(flvjs.Events.ERROR,(t,d)=>{
            console.warn("FLV ERROR:",t,d);
        });
    }
}

/* ------------------------------------------------------
   START REPLAY (same as LIVE)
------------------------------------------------------ */
async function startReplay(imei, filename){
    setStatus("Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Replay Ù„Ù„Ø¬Ù‡Ø§Ø²...");
    const url = `${WEBAPP_URL}?type=playback&deviceId=${imei}&fileName=${filename}`;
    await fetch(url);

    await resetPlayback();

    const stream = `https://${STREAM_HOST}/live/0/${imei}.flv?_=${Date.now()}`;
    setStatus("Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...");
    retryPlay(stream, true);
}

/* ------------------------------------------------------
   LOAD FILES (same as your original)
------------------------------------------------------ */
async function loadFiles(){
    const dev = deviceSelect.value;
    const date = datePicker.value;
    const cam = cameraFilter.value;

    if (!dev || !date){ fileList.innerHTML = "Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®"; return; }

    const sql = `select * where G=${dev} order by A`;
    const url = FILE_SHEET_URL + "&tq=" + encodeURIComponent(sql);

    const txt = await (await fetch(url)).text();
    const json = JSON.parse(txt.substring(47).slice(0,-2));

    const arr = [];
    json.table.rows.forEach(r=>{
        const c = r.c;
        if (!c) return;

        const raw = c[0]?.f || c[0]?.v;
        if (!raw) return;

        const [mdy,time] = raw.split(" ");
        const [M,D,Y] = mdy.split("/");

        const iso = `${Y}-${M.padStart(2,"0")}-${D.padStart(2,"0")}`;
        if (iso !== date) return;

        if (cam !== "all" && String(c[4]?.v) !== cam) return;

        arr.push({
            time,
            filename:c[2]?.v,
            deviceId: c[6]?.v
        });
    });

    allFiles = arr;
    renderFileList(arr);
    updateTimeline(arr);
}

/* ------------------------------------------------------
   RENDER FILES
------------------------------------------------------ */
function renderFileList(list){
    const box = document.getElementById("fileList");
    if (!list.length){ box.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª"; return; }

    box.innerHTML = "";
    list.forEach(f=>{
        box.innerHTML += `
            <div onclick="startReplay('${f.deviceId}','${f.filename}')">
                <b>${f.time}</b> â€“ ${f.filename}
            </div>
        `;
    });
}

/* ------------------------------------------------------
   TIMELINE
------------------------------------------------------ */
const tl = document.getElementById("timeline");
const tlLabel = document.getElementById("timelineLabel");

function updateTimeline(list){
    if (!list.length){ tlLabel.innerText=""; return; }
    tl.max = list.length-1;
    tl.value = 0;
    tlLabel.innerText = list[0].time;
}

tl.oninput = function(){
    const idx = parseInt(tl.value);
    const f = allFiles[idx];
    if (f) tlLabel.innerText = f.time;
};

tl.onchange = function(){
    const idx = parseInt(tl.value);
    const f = allFiles[idx];
    if (f){
        startReplay(f.deviceId, f.filename);
    }
};

</script>
</body>
</html>
